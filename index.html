<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Deliverables and Area Tracker</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap');

        :root {
            --primary-color: #4CAF50; /* Green */
            --secondary-color: #2196F3; /* Blue */
            --accent-color: #FFC107; /* Amber */
            --danger-color: #F44336; /* Red */
            --text-color: #333;
            --bg-color: #f4f7f6;
            --card-bg: #fff;
            --border-color: #ddd;
            --shadow-light: rgba(0, 0, 0, 0.05);
            --shadow-medium: rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1500px;
            margin: 0 auto;
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 20px var(--shadow-medium);
            overflow: hidden;
        }

        /* --- Header --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        #projectTitle {
            font-size: 2.2em;
            font-weight: 700;
            color: var(--primary-color);
            border: none;
            background: transparent;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }

        #projectTitle:hover, #projectTitle:focus {
            background-color: rgba(0, 0, 0, 0.03);
        }

        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #43A047; /* Darker green */
            box-shadow: 0 2px 8px var(--shadow-light);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #1976D2; /* Darker blue */
            box-shadow: 0 2px 8px var(--shadow-light);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #D32F2F; /* Darker red */
            box-shadow: 0 2px 8px var(--shadow-light);
        }

        .btn-outline {
            background-color: transparent;
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .btn-outline:hover {
            background-color: var(--bg-color);
            box-shadow: 0 2px 8px var(--shadow-light);
        }

        /* --- Dashboard --- */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px var(--shadow-light);
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px var(--shadow-medium);
        }

        .card-title {
            font-size: 1.1em;
            color: #777;
            margin-bottom: 10px;
        }

        .card-value {
            font-size: 2.5em;
            font-weight: 700;
            color: var(--primary-color);
        }

        .card.ready .card-value { color: var(--primary-color); }
        .card.in-progress .card-value { color: var(--secondary-color); }
        .card.overdue .card-value { color: var(--danger-color); }
        .card.total .card-value { color: #555; }

        .progress-chart {
            grid-column: span 1 / auto; /* Default for larger screens */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100px; /* Reduced height */
            padding: 15px; /* Reduced padding */
        }

        @media (min-width: 900px) {
            .progress-chart {
                grid-column: span 2 / auto; /* Spans 2 columns on larger screens */
            }
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            .progress-chart {
                grid-column: span 1 / auto; /* Spans 1 column on small screens */
            }
        }

        .chart-container {
            position: relative;
            width: 100px; /* Reduced size */
            height: 100px; /* Reduced size */
            margin-bottom: 10px; /* Adjusted margin */
        }

        .chart-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.4em; /* Adjusted font size */
            font-weight: 700;
            color: var(--text-color);
        }

        /* Canvas styling for donut chart - will be handled by JS */

        /* --- Controls --- */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            align-items: center;
        }

        .controls input[type="text"], .controls select {
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 0.95em;
            flex-grow: 1;
            min-width: 150px;
        }

        /* --- Table --- */
        .table-container {
            overflow-x: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 2px 10px var(--shadow-light);
            margin-bottom: 30px;
        }

        .project-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px; /* Ensure horizontal scroll on smaller screens if many columns */
        }

        .project-table th, .project-table td {
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            text-align: left;
            vertical-align: top;
        }
        
        /* Allow wrapping for text in deliverable cells */
        .project-table td:first-child, .project-table th:first-child {
            white-space: normal;
        }

        .project-table thead th {
            background-color: #eef;
            font-weight: 600;
            color: var(--text-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .project-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .project-table tbody tr:hover {
            background-color: #f0f0f0;
        }

        /* Sticky first column (Section / Deliverable) */
        .project-table .sticky-col {
            position: sticky;
            left: 0;
            background-color: inherit; /* Inherit row background */
            z-index: 5;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
            width: 250px; /* Default width, will be overridden by resize */
            min-width: 150px; /* Minimum width for resizing */
            overflow: hidden; /* Hide overflow when resizing */
        }

        .project-table th.sticky-col {
            background-color: #eef;
            position: relative; /* For resizer handle */
        }
        
        /* Resizer handle for the first column */
        .resizer {
            position: absolute;
            right: 0;
            top: 0;
            width: 8px; /* Make it wider for easier grabbing */
            height: 100%;
            background: transparent; /* Invisible handle */
            cursor: col-resize;
            z-index: 1; /* Above other content */
        }
        .project-table th.sticky-col:hover .resizer {
             background-color: rgba(0, 0, 0, 0.1); /* Visible on hover */
        }


        /* Section/Subsection styling */
        .section-row {
            background-color: #e0f2f7 !important; /* Light blue background for sections */
            font-weight: 600;
            position: relative;
        }

        .section-row .section-name-cell {
            position: relative;
            padding-left: 35px; /* Space for collapse/expand icon */
        }

        .section-badge {
            display: inline-block;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .subsection-row {
            background-color: #f5f5f5 !important;
        }

        .section-toggle {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
            transition: background-color 0.2s ease;
        }

        .section-toggle:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .section-toggle::before {
            content: '‚ñº';
            font-size: 1.2em;
            color: #555;
            transition: transform 0.2s ease;
        }

        .section-row.collapsed .section-toggle::before {
            content: '‚ñ∫';
            transform: rotate(0deg);
        }

        .section-row.collapsed + .subsection-row,
        .section-row.collapsed + .subsection-row + tr { /* Hide subsections and their deliverables */
            display: none;
        }

        /* Input/Select styling within table */
        .editable-cell {
            width: 100%;
            padding: 8px;
            border: 1px solid transparent;
            border-radius: 4px;
            font-size: 0.95em;
            box-sizing: border-box;
            background-color: transparent;
            white-space: normal; /* Allow wrapping for deliverable names */
        }


        .editable-cell:hover {
            border: 1px solid var(--border-color);
            background-color: #fefefe;
        }

        .editable-cell:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
            background-color: white;
        }

        .status-dropdown {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.95em;
            box-sizing: border-box;
            background-color: white;
            cursor: pointer;
            appearance: none; /* Remove default dropdown arrow */
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%204%205%22%3E%3Cpath%20fill%3D%22%23333%22%20d%3D%22M2%200L0%202h4zm0%205L0%203h4z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 8px 10px;
        }

        /* Enhanced Status Dropdown Colors */
        .status-dropdown.NotStarted { background-color: #f0f4f8; color: #5c6c7d; } /* Light Blue-Gray */
        .status-dropdown.InProgress { background-color: #e3f2fd; color: #2196F3; } /* Light Blue */
        .status-dropdown.Review { background-color: #fffde7; color: #FFC107; } /* Light Amber */
        .status-dropdown.Ready { background-color: #e8f5e9; color: var(--primary-color); } /* Light Green */
        .status-dropdown.Overdue { background-color: #ffebee; color: var(--danger-color); } /* Light Red */


        .date-input {
            width: 100%;
            padding: 8px;
            border: 1px solid transparent;
            border-radius: 4px;
            font-size: 0.95em;
            box-sizing: border-box;
            background-color: transparent;
            cursor: pointer;
        }

        .date-input:hover {
            border: 1px solid var(--border-color);
            background-color: #fefefe;
        }
        .date-input:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
            background-color: white;
        }

        /* NEW: Styles for Overdue Dates */
        .date-input.overdue-date-input {
            color: var(--danger-color); /* Red color for overdue dates */
            font-weight: 500;
        }
        .overdue-message {
            color: var(--danger-color);
            font-size: 0.75em;
            margin-top: 3px;
            white-space: normal;
            display: block;
        }

        .overdue-deliverable {
            background-color: #ffebee !important; /* Light red background for overdue */
            color: var(--danger-color);
            font-weight: 500;
        }

        .notes-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            background-color: #ccc;
            border-radius: 50%;
            text-align: center;
            line-height: 16px;
            font-size: 0.7em;
            font-weight: bold;
            color: white;
            margin-left: 5px;
            cursor: pointer;
            position: relative;
            top: -2px;
            transition: background-color 0.2s ease;
        }

        .notes-icon:hover {
            background-color: #aaa;
        }

        .notes-tooltip {
            visibility: hidden;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%; /* Position above the icon */
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s ease;
            white-space: normal; /* Allow text wrapping in tooltip */
            width: 200px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .notes-tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        .notes-icon:hover .notes-tooltip {
            visibility: visible;
            opacity: 1;
        }

        /* Styles for AM Required and Responsible Department in sticky column */
        .deliverable-meta {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
            line-height: 1.3;
            white-space: normal; /* Allow wrapping */
        }
        .deliverable-meta input[type="text"],
        .deliverable-meta select {
            width: calc(100% - 10px); /* Adjust width */
            padding: 3px 5px;
            margin-top: 3px;
            margin-bottom: 3px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            font-size: 0.9em;
            box-sizing: border-box;
        }
        .deliverable-meta input[type="text"]:focus,
        .deliverable-meta select:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 1px rgba(33, 150, 243, 0.2);
        }

        /* --- Action buttons in table --- */
        .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .action-buttons .btn {
            padding: 5px 8px;
            font-size: 0.8em;
            border-radius: 3px;
        }

        .action-buttons .btn-delete {
            background-color: #f44336;
        }

        .action-buttons .btn-delete:hover {
            background-color: #d32f2f;
        }

        /* Area Column Delete Button in Table Header */
        th .area-header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 5px; /* Space between text and button */
        }
        .btn-delete-area {
            background: none;
            border: none;
            color: #888;
            font-size: 1.2em;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            transition: color 0.2s ease;
            opacity: 0; /* Hidden by default */
        }

        .project-table th:hover .btn-delete-area {
            opacity: 1; /* Show on hover of the parent th */
            color: var(--danger-color);
        }

        .btn-delete-area:hover {
            color: #c00;
        }


        /* --- Change Log --- */
        .change-log-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 15px var(--shadow-medium);
            padding: 15px;
            max-width: 350px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 100;
        }

        .change-log-container h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--secondary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }

        #changeLog {
            list-style-type: none;
            padding: 0;
            margin: 0;
            font-size: 0.85em;
        }

        #changeLog li {
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px dotted #eee;
            color: #555;
        }

        #changeLog li:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .change-log-close {
            position: absolute;
            top: 5px;
            right: 10px;
            font-size: 1.2em;
            cursor: pointer;
            color: #888;
        }
        .change-log-close:hover {
            color: #333;
        }

        /* --- Modal Styling --- */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            border-radius: 8px;
            width: 80%;
            max-width: 600px; /* Increased max-width for new modal */
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            position: relative;
        }

        .modal-content h2 {
            margin-top: 0;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .modal-content label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .modal-content input[type="text"],
        .modal-content input[type="number"], /* For AM Required */
        .modal-content select,
        .modal-content textarea { /* For comments */
            width: calc(100% - 22px); /* Account for padding and border */
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1em;
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
        }
        .modal-content textarea {
            min-height: 80px;
            resize: vertical;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 15px;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .deliverable-entry {
            border: 1px solid #eee;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
            background-color: #f9f9f9;
        }

        .deliverable-entry .deliverable-actions {
            display: flex;
            justify-content: flex-end;
            gap: 5px;
            margin-top: 10px;
        }

        .deliverable-entry .comment-section {
            background-color: #eef;
            border: 1px solid #dde;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            display: none; /* Hidden by default */
        }

        /* Responsive adjustments for modal */
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                padding: 15px;
            }
            .modal-content input[type="text"],
            .modal-content input[type="number"],
            .modal-content select,
            .modal-content textarea {
                width: calc(100% - 12px); /* Adjust for smaller padding */
            }
        }


        /* --- Print Mode --- */
        @media print {
            body {
                padding: 0;
                background-color: white;
            }
            .container {
                box-shadow: none;
                padding: 0;
                border-radius: 0;
            }
            .header, .controls, .change-log-container, .btn, .notes-icon, .section-toggle, .action-buttons, .modal, .btn-delete-area {
                display: none !important;
            }
            #projectTitle {
                font-size: 1.8em;
                text-align: center;
                margin-bottom: 20px;
                display: block;
            }
            .dashboard {
                display: block; /* Stack cards */
                margin-bottom: 20px;
            }
            .card {
                box-shadow: none;
                border: 1px solid var(--border-color);
                margin-bottom: 10px;
                text-align: left;
                display: inline-block;
                width: calc(33% - 10px); /* For 3 cards per row */
                vertical-align: top;
                margin-right: 10px;
            }
            .progress-chart {
                display: none !important; /* Hide chart in print */
            }
            .project-table {
                width: 100%;
                border-collapse: collapse;
            }
            .project-table th, .project-table td {
                border: 1px solid #ccc;
                padding: 8px 10px;
                font-size: 0.9em;
            }
            .status-dropdown, .date-input, .editable-cell {
                border: none !important;
                background-color: transparent !important;
                padding: 0 !important;
                font-size: inherit !important;
            }
            .notes-tooltip {
                visibility: visible !important;
                opacity: 1 !important;
                position: static !important;
                transform: none !important;
                background-color: #f0f0f0 !important;
                color: #555 !important;
                padding: 5px !important;
                border: 1px solid #ddd !important;
                margin-top: 5px !important;
                box-shadow: none !important;
            }
            .notes-tooltip::after {
                display: none !important;
            }
            .sticky-col {
                position: static !important;
                box-shadow: none !important;
            }
            .project-table thead th {
                position: static !important;
            }
            .section-row.collapsed + .subsection-row,
            .section-row.collapsed + .subsection-row + tr {
                display: table-row !important; /* Force display for printing */
            }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            .header-actions {
                width: 100%;
                justify-content: flex-start;
                margin-top: 15px;
            }
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            .controls .btn, .controls input, .controls select {
                width: 100%;
            }
            .change-log-container {
                left: 10px;
                right: 10px;
                max-width: unset;
            }
        }

        /* --- Connectivity Indicator --- */
        #connectivityIndicator {
            position: fixed;
            top: 18px;
            right: 18px;
            z-index: 2000;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #ccc;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 2px solid #fff;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #connectivityIndicator:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            top: 110%;
            right: 50%;
            transform: translateX(50%);
            background: #333;
            color: #fff;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.85em;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0,0,0,0.18);
            opacity: 1;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="connectivityIndicator"></div>
    <div class="container">
        <div class="header">
            <input type="text" id="projectTitle" value="My Awesome Project">
            <div class="header-actions">
                <button class="btn btn-primary" id="addAreaBtn">‚ûï Add Area Column</button>
                <button class="btn btn-secondary" id="exportExcelBtn">üìä Export to Excel</button>
                <input type="file" id="importExcelInput" accept=".xlsx, .xls" style="display: none;">
                <button class="btn btn-secondary" id="importExcelBtn">üì• Import from Excel</button>
                <button class="btn btn-outline" id="printReportBtn">üñ®Ô∏è Print Report</button>
                <button class="btn btn-danger" id="resetProjectBtn">üóëÔ∏è Reset Project</button>
            </div>
        </div>

        <div class="dashboard">
            <div class="card total">
                <div class="card-title">Total Deliverables</div>
                <div class="card-value" id="totalDeliverables">0</div>
            </div>
            <div class="card ready">
                <div class="card-title">Ready</div>
                <div class="card-value" id="readyDeliverables">0</div>
            </div>
            <div class="card in-progress">
                <div class="card-title">In Progress</div>
                <div class="card-value" id="inProgressDeliverables">0</div>
            </div>
            <div class="card overdue">
                <div class="card-title">Overdue</div>
                <div class="card-value" id="overdueDeliverables">0</div>
            </div>
            <div class="card progress-chart">
                <div class="card-title">Project Progress</div>
                <div class="chart-container">
                    <canvas id="progressDonutChart"></canvas>
                    <div class="chart-text" id="progressPercentage">0%</div>
                </div>
            </div>
        </div>

        <hr>

        <div class="controls">
            <button class="btn btn-primary" id="addSectionAndDeliverablesBtn">‚ûï Add New Section</button>
            <input type="text" id="addSubsectionInput" placeholder="New subsection name (optional)" style="display: none;">
            <button class="btn btn-secondary" id="addSubsectionBtn" style="display: none;">‚ûï Add Subsection</button>
            <input type="text" id="searchBar" placeholder="Search deliverables...">
            <select id="statusFilter">
                <option value="">All Statuses</option>
                <option value="NotStarted">Not Started</option>
                <option value="InProgress">In Progress</option>
                <option value="Review">Review</option>
                <option value="Ready">Ready</option>
                <option value="Overdue">Overdue</option>
            </select>
            <select id="departmentFilter">
                <option value="">All Departments</option>
            </select>
        </div>

        <div class="table-container">
            <table class="project-table" id="projectTable">
                <thead>
                    <tr>
                        <th class="sticky-col">
                            Section / Deliverable
                            <div class="resizer"></div>
                        </th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

    <div class="change-log-container">
        <h3>Change Log</h3>
        <span class="change-log-close" id="closeChangeLog">&times;</span>
        <ul id="changeLog">
        </ul>
    </div>

    <div id="addAreaModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('addAreaModal')">&times;</span>
            <h2>Add New Area Column</h2>
            <label for="newAreaName">Area Name:</label>
            <input type="text" id="newAreaName" placeholder="e.g., Design Phase, Development, Testing">
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('addAreaModal')">Cancel</button>
                <button class="btn btn-primary" onclick="confirmAddArea()">Add Area</button>
            </div>
        </div>
    </div>

    <div id="addSectionDeliverablesModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('addSectionDeliverablesModal')">&times;</span>
            <h2>ÿ•ÿ∂ÿßŸÅÿ© ŸÇÿ≥ŸÖ ÿ¨ÿØŸäÿØ / ÿ™ÿ≥ŸÑŸäŸÖÿßÿ™</h2>

            <label for="modalSectionName">ÿßÿ≥ŸÖ ÿßŸÑŸÇÿ≥ŸÖ:</label>
            <input type="text" id="modalSectionName" placeholder="ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÇÿ≥ŸÖ ÿßŸÑÿ¨ÿØŸäÿØ">

            <label for="modalSectionNameDropdown">ÿ£Ÿà ÿßÿÆÿ™ÿ± ŸÖŸÜ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ©:</label>
            <select id="modalSectionNameDropdown">
                <option value="">-- ÿßÿÆÿ™ÿ± ŸÇÿ≥ŸÖŸãÿß ŸÖŸàÿ¨ŸàÿØŸãÿß --</option>
            </select>

            <label for="modalSubsectionName">ÿßÿ≥ŸÖ ÿßŸÑŸÇÿ≥ŸÖ ÿßŸÑŸÅÿ±ÿπŸä (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä):</label>
            <input type="text" id="modalSubsectionName" placeholder="ŸÖÿ´ÿßŸÑ: ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖŸàŸÇÿπ">

            <h3>ÿßŸÑŸÄÿ™ÿ≥ŸÑŸäŸÖÿßÿ™ (Deliverables)</h3>
            <div id="deliverablesContainer">
                </div>
            <button class="btn btn-secondary" id="addDeliverableEntryBtn">‚ûï ÿ£ÿ∂ŸÅ ÿ™ÿ≥ŸÑŸäŸÖ ÿ•ÿ∂ÿßŸÅŸä</button>

            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('addSectionDeliverablesModal')">ÿ•ŸÑÿ∫ÿßÿ°</button>
                <button class="btn btn-primary" onclick="confirmAddSectionAndDeliverables()">ÿ•ÿ∂ÿßŸÅÿ©</button>
            </div>
        </div>
    </div>
    <datalist id="departmentList"></datalist>
    <datalist id="amRequiredList"></datalist>

    <script>
        // --- Firebase Initialization ---
        const firebaseConfig = {
            apiKey: "AIzaSyBPYWUqHa6v28jt496_L6ExtXS_pqSQow4",
            authDomain: "shopping-d3ea3.firebaseapp.com",
            databaseURL: "https://shopping-d3ea3-default-rtdb.firebaseio.com",
            projectId: "shopping-d3ea3",
            storageBucket: "shopping-d3ea3.firebasestorage.app",
            messagingSenderId: "434241138137",
            appId: "1:434241138137:web:ce049431ac46db9b93fdc8",
            measurementId: "G-STYC586XED"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const projectRef = db.ref('projectData'); // Reference to the root of your project data

        // --- Data Structure ---
        let projectData = {
            title: "My Awesome Project",
            sections: [], // Each section can contain subsections and deliverables
            areas: [],    // New: Defines the columns (Areas)
            nextSectionId: 1,
            nextDeliverableId: 1,
            nextAreaId: 1 // For unique Area (column) IDs
        };

        const STATUS_OPTIONS = ["NotStarted", "InProgress", "Review", "Ready", "Overdue"];
        const SECTION_COLORS = ['#ADD8E6', '#90EE90', '#FFB6C1', '#FFDAB9', '#E6E6FA', '#FFFACD']; // LightBlue, LightGreen, LightPink, PeachPuff, Lavender, LemonChiffon
        let colorIndex = 0;

        // --- Predefined Lists ---
        const PREDEFINED_DEPARTMENTS = [
            "Project Management Department",
            "Planning & Scheduling Department",
            "Design & Engineering Department",
            "Construction Department",
            "Procurement Department",
            "Contracts Department",
            "Cost Control Department",
            "Quality Assurance & Control (QA/QC)",
            "Health, Safety & Environment (HSE)",
            "Logistics & Supply Chain Department",
            "Finance & Accounting Department",
            "Human Resources (HR) Department",
            "Legal Affairs Department",
            "IT & Systems Department",
            "Stakeholder & Communications Department",
            "Permits & Approvals Department",
            "Operations & Maintenance (O&M)",
            "Business Development Department",
            "Surveying Department",
            "Geotechnical & Soil Investigation Department"
        ];
        const AM_REQUIRED_OPTIONS = [
            "Mandatory",
            "Recommended",
            "If applicable"
        ];

        // --- DOM Elements ---
        const projectTitleInput = document.getElementById('projectTitle');
        const projectTable = document.getElementById('projectTable');
        const addAreaBtn = document.getElementById('addAreaBtn');
        const searchBar = document.getElementById('searchBar');
        const statusFilter = document.getElementById('statusFilter');
        const departmentFilter = document.getElementById('departmentFilter');
        const exportExcelBtn = document.getElementById('exportExcelBtn');
        const importExcelBtn = document.getElementById('importExcelBtn');
        const importExcelInput = document.getElementById('importExcelInput');
        const printReportBtn = document.getElementById('printReportBtn');
        const resetProjectBtn = document.getElementById('resetProjectBtn');
        const connectivityIndicator = document.getElementById('connectivityIndicator');


        // Dashboard elements
        const totalDeliverablesSpan = document.getElementById('totalDeliverables');
        const readyDeliverablesSpan = document.getElementById('readyDeliverables');
        const inProgressDeliverablesSpan = document.getElementById('inProgressDeliverables');
        const overdueDeliverablesSpan = document.getElementById('overdueDeliverables');
        const progressDonutChartCanvas = document.getElementById('progressDonutChart');
        const progressPercentageSpan = document.getElementById('progressPercentage');
        let progressChartInstance; // To store Chart.js instance

        // Change Log elements
        const changeLogList = document.getElementById('changeLog');
        const changeLogCloseBtn = document.getElementById('closeChangeLog');
        let changeLogEntries = [];
        const MAX_CHANGE_LOG_ENTRIES = 5;

        // Modals from original file
        const addAreaModal = document.getElementById('addAreaModal');
        const newAreaNameInput = document.getElementById('newAreaName');

        // NEW MODAL elements for "Add New Section"
        const addSectionDeliverablesModal = document.getElementById('addSectionDeliverablesModal');
        const addSectionAndDeliverablesBtn = document.getElementById('addSectionAndDeliverablesBtn'); // The new main button
        const modalSectionNameInput = document.getElementById('modalSectionName');
        const modalSectionNameDropdown = document.getElementById('modalSectionNameDropdown');
        const modalSubsectionNameInput = document.getElementById('modalSubsectionName');
        const deliverablesContainer = document.getElementById('deliverablesContainer');
        const addDeliverableEntryBtn = document.getElementById('addDeliverableEntryBtn');

        // --- Utility Functions ---

        // Function to get all unique departments from all deliverables
        function getAllDepartments() {
            const departments = new Set(PREDEFINED_DEPARTMENTS); // Start with predefined ones
            getAllDeliverables().forEach(d => {
                if (d.responsibleDepartment) {
                    departments.add(d.responsibleDepartment);
                }
            });
            return Array.from(departments).sort();
        }

        // Function to populate a department dropdown (used for the filter, not for individual deliverable inputs anymore)
        function populateDepartmentFilterDropdown() {
            const selectElement = departmentFilter; // Always target the filter dropdown
            selectElement.innerHTML = '';
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'All Departments';
            selectElement.appendChild(defaultOption);

            const departments = getAllDepartments();
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                selectElement.appendChild(option);
            });

            // Re-select current filter value if it exists
            const currentFilterValue = selectElement.getAttribute('data-current-filter') || '';
            if (currentFilterValue && departments.includes(currentFilterValue)) {
                selectElement.value = currentFilterValue;
            } else {
                selectElement.value = '';
            }
        }

        // --- Modal Functions (Moved to top for scope) ---
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        let deliverableEntryCounter = 0; // To give unique IDs to modal deliverable inputs
        function addDeliverableEntry(initialData = {}) {
            const index = deliverableEntryCounter++;
            const entryDiv = document.createElement('div');
            entryDiv.classList.add('deliverable-entry');
            entryDiv.setAttribute('data-index', index);
            entryDiv.innerHTML = `
                <label for="deliverableName_${index}">ÿßÿ≥ŸÖ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ:</label>
                <input type="text" id="deliverableName_${index}" class="modal-deliverable-name" placeholder="ŸÖÿ´ÿßŸÑ: Feasibility Study Report" value="${initialData.name || ''}">

                <label for="amRequired_${index}">AM Required:</label>
                <input type="text" id="amRequired_${index}" class="modal-am-required" list="amRequiredList" placeholder="ÿ£ÿØÿÆŸÑ ÿßŸÑŸÇŸäŸÖÿ©" value="${initialData.amRequired || ''}">

                <label for="responsibleDepartment_${index}">ÿßŸÑŸÇÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ§ŸàŸÑ:</label>
                <input type="text" id="responsibleDepartment_${index}" class="modal-responsible-department" list="departmentList" placeholder="ÿ£ÿØÿÆŸÑ ÿßŸÑŸÇÿ≥ŸÖ ÿ£Ÿà ÿßÿÆÿ™ÿ±Ÿá" value="${initialData.responsibleDepartment || ''}">

                <div class="deliverable-actions">
                    <button type="button" class="btn btn-outline show-comments-btn" data-index="${index}">üí¨ ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ™ÿπŸÑŸäŸÇÿßÿ™</button>
                    <button type="button" class="btn btn-danger remove-deliverable-entry-btn">ÿ≠ÿ∞ŸÅ</button>
                </div>
                <div class="comment-section">
                    <label for="comments_${index}">ÿßŸÑÿ™ÿπŸÑŸäŸÇÿßÿ™:</label>
                    <textarea id="comments_${index}" class="modal-deliverable-comments" placeholder="ÿ£ÿØÿÆŸÑ ÿ™ÿπŸÑŸäŸÇÿßÿ™ ŸáŸÜÿß...">${initialData.notes || ''}</textarea>
                </div>
            `;
            deliverablesContainer.appendChild(entryDiv);

            // Add event listener for "Show Comments" button
            entryDiv.querySelector('.show-comments-btn').addEventListener('click', (e) => {
                const commentSection = e.target.closest('.deliverable-actions').nextElementSibling;
                commentSection.style.display = commentSection.style.display === 'block' ? 'none' : 'block';
            });

            // Add event listener for "Remove" button
            entryDiv.querySelector('.remove-deliverable-entry-btn').addEventListener('click', (e) => {
                e.target.closest('.deliverable-entry').remove();
            });
        }

        function showAddSectionDeliverablesModal() {
            // Clear previous inputs
            modalSectionNameInput.value = '';
            modalSubsectionNameInput.value = '';
            deliverablesContainer.innerHTML = '';
            addDeliverableEntry(); // Add one empty deliverable entry by default

            // Populate Section Name Dropdown
            modalSectionNameDropdown.innerHTML = '<option value="">-- ÿßÿÆÿ™ÿ± ŸÇÿ≥ŸÖŸãÿß ŸÖŸàÿ¨ŸàÿØŸãÿß --</option>';
            projectData.sections.forEach(section => {
                const option = document.createElement('option');
                option.value = section.name;
                option.textContent = section.name;
                modalSectionNameDropdown.appendChild(option);
            });

            // Handle dropdown change: if a section is selected, clear text input
            modalSectionNameDropdown.onchange = () => {
                if (modalSectionNameDropdown.value !== "") {
                    modalSectionNameInput.value = ""; // Clear manual input if dropdown is used
                }
            };

            // Handle text input change: if text is entered, reset dropdown
            modalSectionNameInput.onkeyup = () => {
                if (modalSectionNameInput.value !== "") {
                    modalSectionNameDropdown.value = ""; // Clear dropdown if manual input is used
                }
            };

            showModal('addSectionDeliverablesModal');
        }

        function confirmAddSectionAndDeliverables() {
            const sectionName = modalSectionNameInput.value.trim() || modalSectionNameDropdown.value.trim();
            const subsectionName = modalSubsectionNameInput.value.trim();
            const deliverableEntries = Array.from(deliverablesContainer.querySelectorAll('.deliverable-entry'));

            if (!sectionName && deliverableEntries.length === 0) {
                alert("ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÇÿ≥ŸÖ ÿ£Ÿà ÿ•ÿ∂ÿßŸÅÿ© ÿ™ÿ≥ŸÑŸäŸÖ Ÿàÿßÿ≠ÿØ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ.");
                return;
            }

            let targetSection = projectData.sections.find(s => s.name === sectionName);
            let isNewSection = false;
            if (!targetSection) {
                isNewSection = true;
                targetSection = {
                    id: `s${projectData.nextSectionId++}`,
                    name: sectionName,
                    type: "section",
                    color: SECTION_COLORS[colorIndex++ % SECTION_COLORS.length],
                    isCollapsed: false,
                    children: []
                };
                projectData.sections.push(targetSection);
                addChangeLogEntry(`ÿ™ŸÖÿ™ ÿ•ÿ∂ÿßŸÅÿ© ŸÇÿ≥ŸÖ ÿ¨ÿØŸäÿØ: "${sectionName}"`);
            }

            let parentForDeliverables = targetSection.children;
            if (subsectionName) {
                // Check if subsection already exists within this section
                let targetSubsection = targetSection.children.find(
                    child => child.type === 'subsection' && child.name === subsectionName
                );
                if (!targetSubsection) {
                    targetSubsection = {
                        id: `sub${projectData.nextSectionId++}`,
                        name: subsectionName,
                        type: "subsection",
                        children: []
                    };
                    targetSection.children.push(targetSubsection);
                    addChangeLogEntry(`ÿ™ŸÖÿ™ ÿ•ÿ∂ÿßŸÅÿ© ŸÇÿ≥ŸÖ ŸÅÿ±ÿπŸä "${subsectionName}" ÿ•ŸÑŸâ ÿßŸÑŸÇÿ≥ŸÖ "${sectionName}"`);
                }
                parentForDeliverables = targetSubsection.children;
            }

            deliverableEntries.forEach(entry => {
                const delivName = entry.querySelector('.modal-deliverable-name').value.trim();
                const amRequired = entry.querySelector('.modal-am-required').value.trim();
                const responsibleDept = entry.querySelector('.modal-responsible-department').value.trim();
                const comments = entry.querySelector('.modal-deliverable-comments').value.trim();

                if (delivName) {
                    const newDeliverable = {
                        id: `d${projectData.nextDeliverableId++}`,
                        name: delivName,
                        type: "deliverable",
                        amRequired: amRequired, // Now directly on deliverable
                        responsibleDepartment: responsibleDept, // Now directly on deliverable
                        notes: comments, // Now directly on deliverable
                        areaData: {} // Area data remains for status/due date
                    };
                    projectData.areas.forEach(area => {
                        newDeliverable.areaData[area.id] = {
                            status: "NotStarted",
                            dueDate: ""
                            // notes, responsibleDepartment, amRequired are now on the deliverable itself
                        };
                    });
                    parentForDeliverables.push(newDeliverable);
                    addChangeLogEntry(`ÿ™ŸÖÿ™ ÿ•ÿ∂ÿßŸÅÿ© ÿ™ÿ≥ŸÑŸäŸÖ "${delivName}"`);
                }
            });

            saveProjectData();
            renderTable();
            closeModal('addSectionDeliverablesModal');
        }

        function showAddAreaModal() {
            newAreaNameInput.value = '';
            showModal('addAreaModal');
        }

        function confirmAddArea() {
            const areaName = newAreaNameInput.value.trim();
            if (areaName) {
                const newAreaId = `area_col_${projectData.nextAreaId++}`;
                projectData.areas.push({ id: newAreaId, name: areaName });

                // Initialize this new area's data for all existing deliverables
                projectData.sections.forEach(sec => {
                    function initializeNewAreaForChildren(item) {
                        if (item.type === 'deliverable') {
                            if (!item.areaData) item.areaData = {};
                            item.areaData[newAreaId] = { status: "NotStarted", dueDate: "" }; // Only status and due date here
                        }
                        if (item.children) {
                            item.children.forEach(child => initializeNewAreaForChildren(child));
                        }
                    }
                    initializeNewAreaForChildren(sec);
                });
                addChangeLogEntry(`Added new area column: "${areaName}"`);
                saveProjectData();
                renderTable();
                closeModal('addAreaModal');
            } else {
                alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©.');
            }
        }

        // --- Firebase Data Handling ---

        // Save data to Firebase
        function saveProjectData() {
            projectRef.set(projectData)
                .then(() => {
                    connectivityIndicator.style.backgroundColor = '#4CAF50'; // Green for connected/saved
                    connectivityIndicator.setAttribute('data-tooltip', 'Connected to Firebase (Saved)');
                    console.log("Project data saved to Firebase successfully!");
                })
                .catch((error) => {
                    connectivityIndicator.style.backgroundColor = '#F44336'; // Red for error
                    connectivityIndicator.setAttribute('data-tooltip', 'Firebase Save Error!');
                    console.error("Error saving project data to Firebase:", error);
                });
        }

        // Load data from Firebase
        function loadProjectData() {
            projectRef.once('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    projectData = data;
                    // Ensure necessary defaults if data is old or incomplete
                    projectData.sections = projectData.sections || [];
                    projectData.areas = projectData.areas || [];
                    projectData.nextSectionId = projectData.nextSectionId || 1;
                    projectData.nextDeliverableId = projectData.nextDeliverableId || 1;
                    projectData.nextAreaId = projectData.nextAreaId || 1;
                    projectData.title = projectData.title || "My Awesome Project";
                    addChangeLogEntry("ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑŸáÿß ÿ®ŸÜÿ¨ÿßÿ≠ ŸÖŸÜ Firebase.");
                } else {
                    addChangeLogEntry("ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ¥ÿ±Ÿàÿπ ŸÅŸä Firebaseÿå ÿ™ŸÖ ÿ®ÿØÿ° ŸÖÿ¥ÿ±Ÿàÿπ ÿ¨ÿØŸäÿØ.");
                }
                renderTable();
                updateDashboard();
                populateDepartmentFilterDropdown();
                populateDatalists();
            }, (error) => {
                connectivityIndicator.style.backgroundColor = '#F44336'; // Red for error
                connectivityIndicator.setAttribute('data-tooltip', 'Firebase Load Error!');
                console.error("Error loading project data from Firebase:", error);
                alert("ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ Firebase. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßÿ™ÿµÿßŸÑŸÉ Ÿàÿ•ÿπÿØÿßÿØÿßÿ™ Firebase.");
            });
        }

        // Real-time listener for Firebase changes
        projectRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                // Prevent re-rendering if data is identical (e.g., from own save)
                if (JSON.stringify(projectData) !== JSON.stringify(data)) {
                    projectData = data;
                    projectData.sections = projectData.sections || [];
                    projectData.areas = projectData.areas || [];
                    projectData.nextSectionId = projectData.nextSectionId || 1;
                    projectData.nextDeliverableId = projectData.nextDeliverableId || 1;
                    projectData.nextAreaId = projectData.nextAreaId || 1;
                    projectData.title = projectData.title || "My Awesome Project";
                    renderTable();
                    updateDashboard();
                    populateDepartmentFilterDropdown();
                    populateDatalists();
                    connectivityIndicator.style.backgroundColor = '#4CAF50'; // Green
                    connectivityIndicator.setAttribute('data-tooltip', 'Connected to Firebase (Auto-updated)');
                    addChangeLogEntry("ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ŸÖŸÜ Firebase.");
                }
            } else {
                // If data is null, assume reset or empty
                projectData = {
                    title: "My Awesome Project",
                    sections: [],
                    areas: [],
                    nextSectionId: 1,
                    nextDeliverableId: 1,
                    nextAreaId: 1
                };
                renderTable();
                updateDashboard();
                populateDepartmentFilterDropdown();
                populateDatalists();
                connectivityIndicator.style.backgroundColor = '#4CAF50'; // Green
                connectivityIndicator.setAttribute('data-tooltip', 'Connected to Firebase (Empty Data)');
                addChangeLogEntry("ŸÇÿßÿπÿØÿ© ÿ®ŸäÿßŸÜÿßÿ™ Firebase ŸÅÿßÿ±ÿ∫ÿ© ÿ£Ÿà ÿ™ŸÖÿ™ ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜŸáÿß. ÿ™ŸÖ ÿ®ÿØÿ° ŸÖÿ¥ÿ±Ÿàÿπ ÿ¨ÿØŸäÿØ.");
            }
        }, (error) => {
            connectivityIndicator.style.backgroundColor = '#F44336'; // Red
            connectivityIndicator.setAttribute('data-tooltip', 'Firebase Disconnected!');
            console.error("Firebase connection error:", error);
            addChangeLogEntry("ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ŸÄ Firebase: " + error.message);
        });


        // --- Core Rendering Functions ---

        function renderTable() {
            const tableHead = projectTable.querySelector('thead tr');
            const tableBody = projectTable.querySelector('tbody');

            // Clear existing headers and body
            tableHead.innerHTML = `<th class="sticky-col">Section / Deliverable<div class="resizer"></div></th>`;
            tableBody.innerHTML = '';

            // Add area columns to header
            projectData.areas.forEach(area => {
                const th = document.createElement('th');
                th.setAttribute('data-area-id', area.id);
                th.innerHTML = `
                    <div class="area-header-content">
                        <span>${area.name}</span>
                        <button class="btn-delete-area" data-area-id="${area.id}">&times;</button>
                    </div>
                `;
                tableHead.appendChild(th);
            });

            // Add rows for sections, subsections, and deliverables
            projectData.sections.forEach(section => {
                // Section row
                const sectionRow = tableBody.insertRow();
                sectionRow.id = section.id;
                sectionRow.classList.add('section-row');
                if (section.isCollapsed) {
                    sectionRow.classList.add('collapsed');
                }
                sectionRow.style.backgroundColor = section.color;
                sectionRow.innerHTML = `
                    <td class="sticky-col section-name-cell" colspan="${projectData.areas.length + 1}">
                        <div class="section-toggle" data-section-id="${section.id}"></div>
                        <span class="section-badge" style="background-color: ${section.color};"></span>
                        <span class="section-text">${section.name}</span>
                        <button class="btn btn-danger btn-sm action-buttons" onclick="deleteSection('${section.id}')">ÿ≠ÿ∞ŸÅ ÿßŸÑŸÇÿ≥ŸÖ</button>
                    </td>
                `;

                // Add an empty cell for each area to maintain column structure if needed (though colspan handles it)
                // for (let i = 0; i < projectData.areas.length; i++) { sectionRow.insertCell(); }


                // Process children (subsections and deliverables)
                renderChildren(tableBody, section.children, section.id, section.isCollapsed);
            });

            // Attach event listeners for dynamic elements
            attachEventListeners();
            updateDashboard();
            populateDepartmentFilterDropdown();
            setupColumnResizing(); // Setup resizer after rendering
        }

        function renderChildren(tableBody, children, parentId, isParentCollapsed) {
            children.forEach(item => {
                if (item.type === 'subsection') {
                    const subsectionRow = tableBody.insertRow();
                    subsectionRow.id = item.id;
                    subsectionRow.classList.add('subsection-row');
                    if (isParentCollapsed) subsectionRow.style.display = 'none'; // Hide if parent is collapsed

                    subsectionRow.innerHTML = `
                        <td class="sticky-col section-name-cell" colspan="${projectData.areas.length + 1}" style="padding-left: 50px;">
                            <span class="section-text"> - ${item.name}</span>
                            <button class="btn btn-danger btn-sm action-buttons" onclick="deleteSubsection('${parentId}', '${item.id}')">ÿ≠ÿ∞ŸÅ ÿßŸÑŸÅÿ±ÿπ</button>
                        </td>
                    `;
                    // for (let i = 0; i < projectData.areas.length; i++) { subsectionRow.insertCell(); }

                    // Render deliverables under this subsection
                    renderChildren(tableBody, item.children, item.id, isParentCollapsed);

                } else if (item.type === 'deliverable') {
                    const deliverableRow = tableBody.insertRow();
                    deliverableRow.id = item.id;
                    deliverableRow.classList.add('deliverable-row');
                    if (isParentCollapsed) deliverableRow.style.display = 'none'; // Hide if parent is collapsed

                    const stickyCell = deliverableRow.insertCell();
                    stickyCell.classList.add('sticky-col');
                    
                    // Check for overdue status
                    const isOverdueDeliverable = projectData.areas.some(area => {
                        const areaInfo = item.areaData[area.id];
                        return areaInfo && areaInfo.status !== "Ready" && areaInfo.dueDate && new Date(areaInfo.dueDate) < new Date();
                    });
                    if (isOverdueDeliverable) {
                        deliverableRow.classList.add('overdue-deliverable');
                    }

                    stickyCell.innerHTML = `
                        <div>
                            <input type="text" value="${item.name}" class="editable-cell deliverable-name-input" data-deliverable-id="${item.id}" placeholder="ÿßÿ≥ŸÖ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ">
                            ${item.notes ? `<span class="notes-icon" data-notes="${item.notes}">i<span class="notes-tooltip">${item.notes}</span></span>` : ''}
                        </div>
                        <div class="deliverable-meta">
                            <label>AM Required:</label>
                            <input type="text" value="${item.amRequired || ''}" class="editable-cell am-required-input" data-deliverable-id="${item.id}" list="amRequiredList" placeholder="AM Required">
                            <label>Responsible Dept:</label>
                            <input type="text" value="${item.responsibleDepartment || ''}" class="editable-cell responsible-department-input" data-deliverable-id="${item.id}" list="departmentList" placeholder="ÿßŸÑŸÇÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ§ŸàŸÑ">
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-danger btn-sm" onclick="deleteDeliverable('${parentId}', '${item.id}')">ÿ≠ÿ∞ŸÅ</button>
                        </div>
                    `;

                    projectData.areas.forEach(area => {
                        const td = deliverableRow.insertCell();
                        const areaInfo = item.areaData[area.id] || { status: "NotStarted", dueDate: "" };
                        
                        const isOverdue = areaInfo.status !== "Ready" && areaInfo.dueDate && new Date(areaInfo.dueDate) < new Date();
                        const dueDateClass = isOverdue ? 'overdue-date-input' : '';
                        const overdueMessage = isOverdue ? `<span class="overdue-message">Overdue by ${Math.ceil((new Date() - new Date(areaInfo.dueDate)) / (1000 * 60 * 60 * 24))} days</span>` : '';

                        td.innerHTML = `
                            <select class="status-dropdown ${areaInfo.status}" data-deliverable-id="${item.id}" data-area-id="${area.id}">
                                ${STATUS_OPTIONS.map(status => `<option value="${status}" ${areaInfo.status === status ? 'selected' : ''}>${status}</option>`).join('')}
                            </select>
                            <input type="date" value="${areaInfo.dueDate}" class="date-input ${dueDateClass}" data-deliverable-id="${item.id}" data-area-id="${area.id}">
                            ${overdueMessage}
                        `;
                    });
                }
            });
        }


        function attachEventListeners() {
            // Project Title
            projectTitleInput.onchange = (e) => {
                projectData.title = e.target.value;
                saveProjectData();
                addChangeLogEntry(`Project title changed to: "${e.target.value}"`);
            };

            // Add Area Button
            addAreaBtn.onclick = showAddAreaModal;

            // Export/Import Buttons
            exportExcelBtn.onclick = exportToExcel;
            importExcelBtn.onclick = () => importExcelInput.click();
            importExcelInput.onchange = importFromExcel;

            // Print Button
            printReportBtn.onclick = () => window.print();

            // Reset Project Button
            resetProjectBtn.onclick = promptResetProject;

            // Search Bar
            searchBar.onkeyup = filterTable;
            searchBar.onchange = filterTable;

            // Status Filter
            statusFilter.onchange = filterTable;

            // Department Filter
            departmentFilter.onchange = filterTable;

            // Add Section / Deliverables button
            addSectionAndDeliverablesBtn.onclick = showAddSectionDeliverablesModal;
            addDeliverableEntryBtn.onclick = () => addDeliverableEntry();

            // Change Log Close button
            changeLogCloseBtn.onclick = () => document.querySelector('.change-log-container').style.display = 'none';

            // Delegate events for dynamically added elements (inputs, selects, toggles, delete area buttons)
            projectTable.onchange = (e) => {
                if (e.target.classList.contains('status-dropdown')) {
                    const deliverableId = e.target.dataset.deliverableId;
                    const areaId = e.target.dataset.areaId;
                    const newStatus = e.target.value;
                    updateDeliverableStatus(deliverableId, areaId, newStatus);
                    e.target.className = `status-dropdown ${newStatus}`; // Update class for styling
                } else if (e.target.classList.contains('date-input')) {
                    const deliverableId = e.target.dataset.deliverableId;
                    const areaId = e.target.dataset.areaId;
                    const newDate = e.target.value;
                    updateDeliverableDueDate(deliverableId, areaId, newDate);
                } else if (e.target.classList.contains('deliverable-name-input')) {
                    const deliverableId = e.target.dataset.deliverableId;
                    const newName = e.target.value.trim();
                    updateDeliverableName(deliverableId, newName);
                } else if (e.target.classList.contains('am-required-input')) {
                    const deliverableId = e.target.dataset.deliverableId;
                    const newValue = e.target.value.trim();
                    updateDeliverableAMRequired(deliverableId, newValue);
                } else if (e.target.classList.contains('responsible-department-input')) {
                    const deliverableId = e.target.dataset.deliverableId;
                    const newValue = e.target.value.trim();
                    updateDeliverableResponsibleDepartment(deliverableId, newValue);
                }
            };

            projectTable.onclick = (e) => {
                if (e.target.classList.contains('section-toggle')) {
                    toggleSectionCollapse(e.target.dataset.sectionId);
                } else if (e.target.classList.contains('btn-delete-area')) {
                    deleteAreaColumn(e.target.dataset.areaId);
                }
            };
        }

        // --- Data Update Functions (for individual cells, auto-saves) ---

        function updateDeliverableStatus(deliverableId, areaId, newStatus) {
            findDeliverable(deliverableId, (deliverable) => {
                if (!deliverable.areaData) deliverable.areaData = {};
                if (!deliverable.areaData[areaId]) deliverable.areaData[areaId] = {};
                const oldStatus = deliverable.areaData[areaId].status;
                deliverable.areaData[areaId].status = newStatus;
                addChangeLogEntry(`Status of "${deliverable.name}" in Area "${projectData.areas.find(a => a.id === areaId)?.name || areaId}" changed from "${oldStatus}" to "${newStatus}"`);
                saveProjectData();
                updateDashboard();
                renderTable(); // Re-render to update overdue styling potentially
            });
        }

        function updateDeliverableDueDate(deliverableId, areaId, newDate) {
            findDeliverable(deliverableId, (deliverable) => {
                if (!deliverable.areaData) deliverable.areaData = {};
                if (!deliverable.areaData[areaId]) deliverable.areaData[areaId] = {};
                const oldDate = deliverable.areaData[areaId].dueDate;
                deliverable.areaData[areaId].dueDate = newDate;
                addChangeLogEntry(`Due Date of "${deliverable.name}" in Area "${projectData.areas.find(a => a.id === areaId)?.name || areaId}" changed from "${oldDate || 'empty'}" to "${newDate || 'empty'}"`);
                saveProjectData();
                updateDashboard();
                renderTable(); // Re-render to update overdue styling
            });
        }

        function updateDeliverableName(deliverableId, newName) {
            findDeliverable(deliverableId, (deliverable) => {
                const oldName = deliverable.name;
                deliverable.name = newName;
                addChangeLogEntry(`Deliverable name changed from "${oldName}" to "${newName}"`);
                saveProjectData();
            });
        }

        function updateDeliverableAMRequired(deliverableId, newValue) {
            findDeliverable(deliverableId, (deliverable) => {
                const oldValue = deliverable.amRequired;
                deliverable.amRequired = newValue;
                addChangeLogEntry(`AM Required for "${deliverable.name}" changed from "${oldValue || 'empty'}" to "${newValue || 'empty'}"`);
                saveProjectData();
                populateDatalists(); // Update datalist if a new value is added
            });
        }

        function updateDeliverableResponsibleDepartment(deliverableId, newValue) {
            findDeliverable(deliverableId, (deliverable) => {
                const oldValue = deliverable.responsibleDepartment;
                deliverable.responsibleDepartment = newValue;
                addChangeLogEntry(`Responsible Department for "${deliverable.name}" changed from "${oldValue || 'empty'}" to "${newValue || 'empty'}"`);
                saveProjectData();
                populateDepartmentFilterDropdown(); // Update filter dropdown if a new department is added
                populateDatalists(); // Update datalist if a new value is added
            });
        }

        // --- Data Traversal/Manipulation Helpers ---

        // Helper to find a deliverable by ID and execute a callback
        function findDeliverable(deliverableId, callback, collection = projectData.sections) {
            for (const section of collection) {
                if (section.type === 'deliverable' && section.id === deliverableId) {
                    callback(section);
                    return true;
                }
                if (section.children) {
                    const found = findDeliverable(deliverableId, callback, section.children);
                    if (found) return true;
                }
            }
            return false;
        }

        // Helper to get all deliverables
        function getAllDeliverables(collection = projectData.sections, deliverables = []) {
            collection.forEach(item => {
                if (item.type === 'deliverable') {
                    deliverables.push(item);
                }
                if (item.children) {
                    getAllDeliverables(item.children, deliverables);
                }
            });
            return deliverables;
        }

        // --- UI Interactions ---

        function toggleSectionCollapse(sectionId) {
            const section = projectData.sections.find(s => s.id === sectionId);
            if (section) {
                section.isCollapsed = !section.isCollapsed;
                addChangeLogEntry(`${section.name} section ${section.isCollapsed ? 'collapsed' : 'expanded'}.`);
                saveProjectData(); // Save collapse state
                renderTable(); // Re-render to apply collapse/expand
            }
        }

        function deleteSection(sectionId) {
            if (confirm("ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ÿ£ŸÜŸÉ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑŸÇÿ≥ŸÖ ÿ®ŸÉŸÑ ÿ™ÿ≥ŸÑŸäŸÖÿßÿ™Ÿá Ÿàÿ£ŸÇÿ≥ÿßŸÖŸá ÿßŸÑŸÅÿ±ÿπŸäÿ©ÿü Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ° ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜŸá.")) {
                const initialLength = projectData.sections.length;
                projectData.sections = projectData.sections.filter(sec => sec.id !== sectionId);
                if (projectData.sections.length < initialLength) {
                    addChangeLogEntry(`Section with ID ${sectionId} deleted.`);
                    saveProjectData();
                    renderTable();
                }
            }
        }

        function deleteSubsection(sectionId, subsectionId) {
            if (confirm("ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ÿ£ŸÜŸÉ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑŸÇÿ≥ŸÖ ÿßŸÑŸÅÿ±ÿπŸä ÿ®ŸÉŸÑ ÿ™ÿ≥ŸÑŸäŸÖÿßÿ™Ÿáÿü Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ° ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜŸá.")) {
                const section = projectData.sections.find(sec => sec.id === sectionId);
                if (section && section.children) {
                    const initialLength = section.children.length;
                    section.children = section.children.filter(sub => sub.id !== subsectionId);
                    if (section.children.length < initialLength) {
                        addChangeLogEntry(`Subsection with ID ${subsectionId} deleted from section ${sectionId}.`);
                        saveProjectData();
                        renderTable();
                    }
                }
            }
        }

        function deleteDeliverable(parentId, deliverableId) {
            if (confirm("ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ÿ£ŸÜŸÉ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖÿü Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ° ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜŸá.")) {
                // Find the parent (section or subsection)
                let parentCollection = projectData.sections;
                let foundParent = false;
                function searchAndDelete(items) {
                    for (let i = 0; i < items.length; i++) {
                        if (items[i].id === parentId) {
                            items[i].children = items[i].children.filter(d => d.id !== deliverableId);
                            foundParent = true;
                            return;
                        }
                        if (items[i].children) {
                            searchAndDelete(items[i].children);
                            if (foundParent) return;
                        }
                    }
                }
                searchAndDelete(parentCollection);

                if (foundParent) {
                    addChangeLogEntry(`Deliverable with ID ${deliverableId} deleted.`);
                    saveProjectData();
                    renderTable();
                }
            }
        }

        function deleteAreaColumn(areaId) {
            if (confirm("ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ÿ£ŸÜŸÉ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿπŸÖŸàÿØ (ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©)ÿü ÿ≥Ÿäÿ§ÿØŸä Ÿáÿ∞ÿß ÿ•ŸÑŸâ ÿ•ÿ≤ÿßŸÑÿ© ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ±ÿ™ÿ®ÿ∑ÿ© ÿ®Ÿáÿ∞ÿß ÿßŸÑÿπŸÖŸàÿØ ŸÖŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖÿßÿ™.")) {
                // Remove the area from projectData.areas
                projectData.areas = projectData.areas.filter(area => area.id !== areaId);

                // Remove the areaData for this column from all deliverables
                getAllDeliverables().forEach(deliverable => {
                    if (deliverable.areaData && deliverable.areaData[areaId]) {
                        delete deliverable.areaData[areaId];
                    }
                });
                addChangeLogEntry(`Area column with ID ${areaId} deleted.`);
                saveProjectData();
                renderTable();
            }
        }

        function filterTable() {
            const searchText = searchBar.value.toLowerCase();
            const selectedStatus = statusFilter.value;
            const selectedDepartment = departmentFilter.value;

            const allRows = projectTable.querySelectorAll('tbody tr');
            const allDeliverables = getAllDeliverables();

            // First, determine which deliverables match the filters
            const matchingDeliverableIds = new Set();
            allDeliverables.forEach(deliverable => {
                const matchesSearch = searchText === '' ||
                    deliverable.name.toLowerCase().includes(searchText) ||
                    (deliverable.amRequired && deliverable.amRequired.toLowerCase().includes(searchText)) ||
                    (deliverable.responsibleDepartment && deliverable.responsibleDepartment.toLowerCase().includes(searchText)) ||
                    (deliverable.notes && deliverable.notes.toLowerCase().includes(searchText));

                const matchesStatus = selectedStatus === '' ||
                    projectData.areas.some(area => deliverable.areaData[area.id]?.status === selectedStatus);

                const matchesDepartment = selectedDepartment === '' ||
                    deliverable.responsibleDepartment === selectedDepartment;

                if (matchesSearch && matchesStatus && matchesDepartment) {
                    matchingDeliverableIds.add(deliverable.id);
                }
            });

            // Iterate through all rows and decide visibility
            allRows.forEach(row => {
                if (row.classList.contains('section-row') || row.classList.contains('subsection-row')) {
                    // For sections/subsections, we need to check if any of their *descendant deliverables* match
                    const sectionId = row.id; // Could be section or subsection ID
                    const sectionOrSubsection = findItemById(sectionId, projectData.sections);
                    if (sectionOrSubsection) {
                        const descendantDeliverables = getAllDeliverables([sectionOrSubsection]);
                        const hasMatchingDeliverable = descendantDeliverables.some(d => matchingDeliverableIds.has(d.id));
                        row.style.display = hasMatchingDeliverable ? '' : 'none';
                    }
                } else if (row.classList.contains('deliverable-row')) {
                    row.style.display = matchingDeliverableIds.has(row.id) ? '' : 'none';
                }
            });
        }

        function findItemById(id, collection) {
            for (const item of collection) {
                if (item.id === id) {
                    return item;
                }
                if (item.children) {
                    const found = findItemById(id, item.children);
                    if (found) return found;
                }
            }
            return null;
        }

        // --- Dashboard Update ---

        function updateDashboard() {
            const allDelivs = getAllDeliverables();
            const total = allDelivs.length;
            let readyCount = 0;
            let inProgressCount = 0;
            let overdueCount = 0;

            allDelivs.forEach(deliv => {
                // Determine status for dashboard based on all areas
                const statuses = projectData.areas.map(area => deliv.areaData[area.id]?.status || 'NotStarted');
                const dueDates = projectData.areas.map(area => deliv.areaData[area.id]?.dueDate || '');

                const isReadyInAllAreas = statuses.every(status => status === "Ready");
                const hasInProgress = statuses.some(status => status === "InProgress" || status === "Review");
                const hasOverdue = statuses.some((status, index) => {
                    const dueDate = dueDates[index];
                    return status !== "Ready" && dueDate && new Date(dueDate) < new Date();
                });

                if (isReadyInAllAreas) {
                    readyCount++;
                } else if (hasOverdue) { // Overdue takes precedence over InProgress for dashboard count
                    overdueCount++;
                } else if (hasInProgress) {
                    inProgressCount++;
                }
            });

            totalDeliverablesSpan.textContent = total;
            readyDeliverablesSpan.textContent = readyCount;
            inProgressDeliverablesSpan.textContent = inProgressCount;
            overdueDeliverablesSpan.textContent = overdueCount;

            // Update donut chart
            const completedPercentage = total > 0 ? ((readyCount / total) * 100).toFixed(0) : 0;
            progressPercentageSpan.textContent = `${completedPercentage}%`;

            if (progressChartInstance) {
                progressChartInstance.destroy();
            }

            const ctx = progressDonutChartCanvas.getContext('2d');
            progressChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Ready', 'In Progress', 'Overdue', 'Not Started'],
                    datasets: [{
                        data: [readyCount, inProgressCount, overdueCount, total - readyCount - inProgressCount - overdueCount],
                        backgroundColor: [
                            'var(--primary-color)', // Ready
                            'var(--secondary-color)', // In Progress
                            'var(--danger-color)', // Overdue
                            '#ccc' // Not Started / Other
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%', // Make it a donut chart
                    plugins: {
                        legend: {
                            display: false // Hide legend
                        },
                        tooltip: {
                            enabled: true // Enable tooltips on hover
                        }
                    }
                }
            });
        }

        // --- Excel Import/Export ---

        function exportToExcel() {
            // Flatten the project data into a sheet-friendly format
            const dataToExport = [];
            dataToExport.push(["Section", "Subsection", "Deliverable Name", "AM Required", "Responsible Department", "Notes", ...projectData.areas.flatMap(a => [`${a.name} Status`, `${a.name} Due Date`])]);

            projectData.sections.forEach(section => {
                function processItem(item, currentSection, currentSubsection = "") {
                    if (item.type === 'section') {
                        currentSection = item.name;
                        currentSubsection = "";
                    } else if (item.type === 'subsection') {
                        currentSubsection = item.name;
                    } else if (item.type === 'deliverable') {
                        const row = [currentSection, currentSubsection, item.name, item.amRequired || '', item.responsibleDepartment || '', item.notes || ''];
                        projectData.areas.forEach(area => {
                            const areaInfo = item.areaData[area.id] || {};
                            row.push(areaInfo.status || 'NotStarted');
                            row.push(areaInfo.dueDate || '');
                        });
                        dataToExport.push(row);
                    }

                    if (item.children) {
                        item.children.forEach(child => processItem(child, currentSection, currentSubsection));
                    }
                }
                processItem(section, "");
            });

            const ws = XLSX.utils.aoa_to_sheet(dataToExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Project Data");
            XLSX.writeFile(wb, `${projectData.title.replace(/[^a-z0-9]/gi, '_')}_Project_Tracker.xlsx`);
            addChangeLogEntry("ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿ™ŸÖ ÿ™ÿµÿØŸäÿ±Ÿáÿß ÿ•ŸÑŸâ Excel.");
        }


        function importFromExcel(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    if (json.length < 2) {
                        alert("ŸÖŸÑŸÅ Excel ŸÅÿßÿ±ÿ∫ ÿ£Ÿà ŸÑÿß Ÿäÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ÿ®ŸäÿßŸÜÿßÿ™ ŸÉÿßŸÅŸäÿ©.");
                        return;
                    }

                    const headers = json[0];
                    const rows = json.slice(1);

                    // Reinitialize project data for import
                    projectData = {
                        title: projectData.title, // Keep existing title or default
                        sections: [],
                        areas: [],
                        nextSectionId: 1,
                        nextDeliverableId: 1,
                        nextAreaId: 1
                    };

                    const newAreas = new Set();
                    const areaStatusRegex = /^(.*) Status$/;
                    const areaDueDateRegex = /^(.*) Due Date$/;

                    // Extract new areas from headers
                    headers.forEach(header => {
                        let match = header.match(areaStatusRegex);
                        if (match) newAreas.add(match[1]);
                        match = header.match(areaDueDateRegex);
                        if (match) newAreas.add(match[1]);
                    });

                    // Add new areas to projectData.areas
                    Array.from(newAreas).sort().forEach(areaName => {
                        projectData.areas.push({ id: `area_col_${projectData.nextAreaId++}`, name: areaName });
                    });


                    rows.forEach(row => {
                        const rowData = {};
                        headers.forEach((header, index) => {
                            rowData[header] = row[index];
                        });

                        const sectionName = rowData["Section"]?.trim();
                        const subsectionName = rowData["Subsection"]?.trim();
                        const deliverableName = rowData["Deliverable Name"]?.trim();

                        if (!deliverableName) return; // Skip rows without deliverable name

                        let targetSection = projectData.sections.find(s => s.name === sectionName);
                        if (!targetSection) {
                            targetSection = {
                                id: `s${projectData.nextSectionId++}`,
                                name: sectionName,
                                type: "section",
                                color: SECTION_COLORS[colorIndex++ % SECTION_COLORS.length],
                                isCollapsed: false,
                                children: []
                            };
                            projectData.sections.push(targetSection);
                        }

                        let parentForDeliverables = targetSection.children;
                        if (subsectionName) {
                            let targetSubsection = targetSection.children.find(
                                child => child.type === 'subsection' && child.name === subsectionName
                            );
                            if (!targetSubsection) {
                                targetSubsection = {
                                    id: `sub${projectData.nextSectionId++}`,
                                    name: subsectionName,
                                    type: "subsection",
                                    children: []
                                };
                                targetSection.children.push(targetSubsection);
                            }
                            parentForDeliverables = targetSubsection.children;
                        }

                        const newDeliverable = {
                            id: `d${projectData.nextDeliverableId++}`,
                            name: deliverableName,
                            type: "deliverable",
                            amRequired: rowData["AM Required"] || '',
                            responsibleDepartment: rowData["Responsible Department"] || '',
                            notes: rowData["Notes"] || '',
                            areaData: {}
                        };

                        projectData.areas.forEach(area => {
                            const statusHeader = `${area.name} Status`;
                            const dueDateHeader = `${area.name} Due Date`;
                            newDeliverable.areaData[area.id] = {
                                status: rowData[statusHeader] || 'NotStarted',
                                dueDate: rowData[dueDateHeader] ? new Date(rowData[dueDateHeader]).toISOString().split('T')[0] : '' // Format date to YYYY-MM-DD
                            };
                        });
                        parentForDeliverables.push(newDeliverable);
                    });

                    saveProjectData();
                    renderTable();
                    alert("ÿ™ŸÖ ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ŸÖŸÑŸÅ Excel ÿ®ŸÜÿ¨ÿßÿ≠!");
                    addChangeLogEntry("ÿ™ŸÖ ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ŸÖŸÜ Excel.");

                } catch (e) {
                    console.error("Error importing Excel:", e);
                    alert("ÿÆÿ∑ÿ£ ŸÅŸä ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ŸÖŸÑŸÅ Excel. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑŸÖŸÑŸÅ.");
                } finally {
                    event.target.value = ''; // Clear the file input
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // --- Change Log Functions ---

        function addChangeLogEntry(message) {
            const timestamp = new Date().toLocaleString('ar-EG', {
                hour: '2-digit',
                minute: '2-digit',
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            changeLogEntries.unshift(`[${timestamp}] ${message}`); // Add to the beginning
            if (changeLogEntries.length > MAX_CHANGE_LOG_ENTRIES) {
                changeLogEntries.pop(); // Remove oldest entry if max is exceeded
            }
            updateChangeLogDisplay();
        }

        function updateChangeLogDisplay() {
            changeLogList.innerHTML = changeLogEntries.map(entry => `<li>${entry}</li>`).join('');
        }

        // --- Initial Load ---

        document.addEventListener('DOMContentLoaded', () => {
            loadProjectData(); // Load data from Firebase on startup
            attachEventListeners();
            populateDatalists();
            updateChangeLogDisplay(); // Display initial change log (if any)
            updateDashboard(); // Initial dashboard update
        });

        function populateDatalists() {
            const departmentDatalist = document.getElementById('departmentList');
            departmentDatalist.innerHTML = '';
            getAllDepartments().forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                departmentDatalist.appendChild(option);
            });

            const amRequiredDatalist = document.getElementById('amRequiredList');
            amRequiredDatalist.innerHTML = '';
            AM_REQUIRED_OPTIONS.forEach(optionText => {
                const option = document.createElement('option');
                option.value = optionText;
                amRequiredDatalist.appendChild(option);
            });

            // Add any custom AM Required values from existing data
            const existingAmRequired = new Set();
            getAllDeliverables().forEach(d => {
                if (d.amRequired && !AM_REQUIRED_OPTIONS.includes(d.amRequired)) {
                    existingAmRequired.add(d.amRequired);
                }
            });
            Array.from(existingAmRequired).sort().forEach(val => {
                const option = document.createElement('option');
                option.value = val;
                amRequiredDatalist.appendChild(option);
            });
        }

        function promptResetProject() {
            const confirmationCode = "250389";
            const userInput = prompt(`ŸÑÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿ®ÿßŸÑŸÉÿßŸÖŸÑ ŸàŸÖÿ≥ÿ≠ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ÿå Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸÉŸàÿØ : Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ° ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜŸá!`);

            if (userInput === confirmationCode) {
                if (confirm("ÿ™ŸÖ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸÉŸàÿØ ÿßŸÑÿµÿ≠Ÿäÿ≠. ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ÿ™ŸÖÿßŸÖŸãÿß ÿ£ŸÜŸÉ ÿ™ÿ±ŸäÿØ ŸÖÿ≥ÿ≠ ÿ¨ŸÖŸäÿπ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ŸÖŸÜ Firebaseÿü")) {
                    resetProject();
                } else {
                    alert("ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿπŸÖŸÑŸäÿ© ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ.");
                }
            } else if (userInput !== null) { // If user clicked cancel, userInput is null
                alert("ÿßŸÑŸÉŸàÿØ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠. ÿ™ŸÖ ÿ±ŸÅÿ∂ ÿπŸÖŸÑŸäÿ© ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ.");
            }
        }

        function resetProject() {
            projectRef.remove()
                .then(() => {
                    projectData = {
                        title: "My Awesome Project",
                        sections: [],
                        areas: [],
                        nextSectionId: 1,
                        nextDeliverableId: 1,
                        nextAreaId: 1
                    };
                    renderTable();
                    updateDashboard();
                    populateDepartmentFilterDropdown();
                    populateDatalists();
                    addChangeLogEntry("ÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿ®ÿßŸÑŸÉÿßŸÖŸÑ ŸàŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ Firebase.");
                    alert("ÿ™ŸÖÿ™ ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿ®ŸÜÿ¨ÿßÿ≠!");
                })
                .catch((error) => {
                    console.error("Error resetting project:", error);
                    alert("ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ: " + error.message);
                });
        }


        // --- Column Resizing Logic (for Section / Deliverable column) ---
        function setupColumnResizing() {
            const headerCell = document.querySelector('.project-table th.sticky-col');
            const resizer = headerCell.querySelector('.resizer');
            let startX, startWidth;

            resizer.addEventListener('mousedown', (e) => {
                startX = e.clientX;
                startWidth = headerCell.offsetWidth;
                document.addEventListener('mousemove', doResize);
                document.addEventListener('mouseup', stopResize);
                document.body.style.cursor = 'col-resize'; // Change cursor globally
                projectTable.style.userSelect = 'none'; // Prevent text selection during drag
                projectTable.style.pointerEvents = 'none'; // Disable other table interactions
            });

            function doResize(e) {
                const newWidth = startWidth + (e.clientX - startX);
                // Set a minimum width
                if (newWidth > 150) {
                    headerCell.style.width = `${newWidth}px`;
                }
            }

            function stopResize() {
                document.removeEventListener('mousemove', doResize);
                document.removeEventListener('mouseup', stopResize);
                document.body.style.cursor = 'default';
                projectTable.style.userSelect = 'auto';
                projectTable.style.pointerEvents = 'auto';
            }
        }

    </script>
</body>
</html>
