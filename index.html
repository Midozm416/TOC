<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Deliverables and Area Tracker</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap');

        :root {
            --primary-color: #4CAF50; /* Green */
            --secondary-color: #2196F3; /* Blue */
            --accent-color: #FFC107; /* Amber */
            --danger-color: #F44336; /* Red */
            --text-color: #333;
            --bg-color: #f4f7f6;
            --card-bg: #fff;
            --border-color: #ddd;
            --shadow-light: rgba(0, 0, 0, 0.05);
            --shadow-medium: rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1500px;
            margin: 0 auto;
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 20px var(--shadow-medium);
            overflow: hidden;
        }

        /* --- Header --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        #projectTitle {
            font-size: 2.2em;
            font-weight: 700;
            color: var(--primary-color);
            border: none;
            background: transparent;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }

        #projectTitle:hover, #projectTitle:focus {
            background-color: rgba(0, 0, 0, 0.03);
        }

        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #43A047; /* Darker green */
            box-shadow: 0 2px 8px var(--shadow-light);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #1976D2; /* Darker blue */
            box-shadow: 0 2px 8px var(--shadow-light);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #D32F2F; /* Darker red */
            box-shadow: 0 2px 8px var(--shadow-light);
        }

        .btn-outline {
            background-color: transparent;
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .btn-outline:hover {
            background-color: var(--bg-color);
            box-shadow: 0 2px 8px var(--shadow-light);
        }

        /* --- Dashboard --- */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px var(--shadow-light);
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px var(--shadow-medium);
        }

        .card-title {
            font-size: 1.1em;
            color: #777;
            margin-bottom: 10px;
        }

        .card-value {
            font-size: 2.5em;
            font-weight: 700;
            color: var(--primary-color);
        }

        .card.ready .card-value { color: var(--primary-color); }
        .card.in-progress .card-value { color: var(--secondary-color); }
        .card.overdue .card-value { color: var(--danger-color); }
        .card.total .card-value { color: #555; }

        .progress-chart {
            grid-column: span 1 / auto; /* Default for larger screens */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 180px; /* Ensure consistent height */
        }

        @media (min-width: 900px) {
            .progress-chart {
                grid-column: span 2 / auto; /* Spans 2 columns on larger screens */
            }
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            .progress-chart {
                grid-column: span 1 / auto; /* Spans 1 column on small screens */
            }
        }

        .chart-container {
            position: relative;
            width: 150px;
            height: 150px;
            margin-bottom: 15px;
        }

        .chart-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.8em;
            font-weight: 700;
            color: var(--text-color);
        }

        /* Canvas styling for donut chart - will be handled by JS */

        /* --- Controls --- */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            align-items: center;
        }

        .controls input[type="text"], .controls select {
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 0.95em;
            flex-grow: 1;
            min-width: 150px;
        }

        /* --- Table --- */
        .table-container {
            overflow-x: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 2px 10px var(--shadow-light);
            margin-bottom: 30px;
        }

        .project-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px; /* Ensure horizontal scroll on smaller screens if many columns */
        }

        .project-table th, .project-table td {
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            text-align: left;
            vertical-align: top;
            white-space: nowrap; /* Prevent wrapping in cells */
        }

        .project-table thead th {
            background-color: #eef;
            font-weight: 600;
            color: var(--text-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .project-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .project-table tbody tr:hover {
            background-color: #f0f0f0;
        }

        /* Sticky first column */
        .project-table .sticky-col {
            position: sticky;
            left: 0;
            background-color: inherit; /* Inherit row background */
            z-index: 5;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
        }

        .project-table th.sticky-col {
            background-color: #eef;
        }

        /* Section/Subsection styling */
        .section-row {
            background-color: #e0f2f7 !important; /* Light blue background for sections */
            font-weight: 600;
            position: relative;
        }

        .section-row .section-name-cell {
            position: relative;
            padding-left: 35px; /* Space for collapse/expand icon */
        }

        .section-badge {
            display: inline-block;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .subsection-row {
            background-color: #f5f5f5 !important;
        }

        .section-toggle {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
            transition: background-color 0.2s ease;
        }

        .section-toggle:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .section-toggle::before {
            content: '‚ñº';
            font-size: 1.2em;
            color: #555;
            transition: transform 0.2s ease;
        }

        .section-row.collapsed .section-toggle::before {
            content: '‚ñ∫';
            transform: rotate(0deg);
        }

        .section-row.collapsed + .subsection-row,
        .section-row.collapsed + .subsection-row + tr { /* Hide subsections and their deliverables */
            display: none;
        }

        /* Input/Select styling within table */
        .editable-cell {
            width: 100%;
            padding: 8px;
            border: 1px solid transparent;
            border-radius: 4px;
            font-size: 0.95em;
            box-sizing: border-box;
            background-color: transparent;
        }
        .editable-cell:not([type="date"]):not(select) { /* Only text inputs should get this hover/focus */
            white-space: normal; /* Allow wrapping for deliverable names */
        }


        .editable-cell:hover {
            border: 1px solid var(--border-color);
            background-color: #fefefe;
        }

        .editable-cell:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
            background-color: white;
        }

        .status-dropdown {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.95em;
            box-sizing: border-box;
            background-color: white;
            cursor: pointer;
            appearance: none; /* Remove default dropdown arrow */
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%204%205%22%3E%3Cpath%20fill%3D%22%23333%22%20d%3D%22M2%200L0%202h4zm0%205L0%203h4z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 8px 10px;
        }

        /* Enhanced Status Dropdown Colors */
        .status-dropdown.NotStarted { background-color: #f0f4f8; color: #5c6c7d; } /* Light Blue-Gray */
        .status-dropdown.InProgress { background-color: #e3f2fd; color: #2196F3; } /* Light Blue */
        .status-dropdown.Review { background-color: #fffde7; color: #FFC107; } /* Light Amber */
        .status-dropdown.Ready { background-color: #e8f5e9; color: var(--primary-color); } /* Light Green */
        .status-dropdown.Overdue { background-color: #ffebee; color: var(--danger-color); } /* Light Red */


        .date-input {
            width: 100%;
            padding: 8px;
            border: 1px solid transparent;
            border-radius: 4px;
            font-size: 0.95em;
            box-sizing: border-box;
            background-color: transparent;
            cursor: pointer;
        }

        .date-input:hover {
            border: 1px solid var(--border-color);
            background-color: #fefefe;
        }
        .date-input:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
            background-color: white;
        }

        /* NEW: Styles for Overdue Dates */
        .date-input.overdue-date-input {
            color: var(--danger-color); /* Red color for overdue dates */
            font-weight: 500;
        }
        .overdue-message {
            color: var(--danger-color);
            font-size: 0.75em;
            margin-top: 3px;
            white-space: normal;
            display: block;
        }

        .overdue-deliverable {
            background-color: #ffebee !important; /* Light red background for overdue */
            color: var(--danger-color);
            font-weight: 500;
        }

        .notes-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            background-color: #ccc;
            border-radius: 50%;
            text-align: center;
            line-height: 16px;
            font-size: 0.7em;
            font-weight: bold;
            color: white;
            margin-left: 5px;
            cursor: pointer;
            position: relative;
            top: -2px;
            transition: background-color 0.2s ease;
        }

        .notes-icon:hover {
            background-color: #aaa;
        }

        .notes-tooltip {
            visibility: hidden;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%; /* Position above the icon */
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s ease;
            white-space: normal; /* Allow text wrapping in tooltip */
            width: 200px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .notes-tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        .notes-icon:hover .notes-tooltip {
            visibility: visible;
            opacity: 1;
        }

        /* Styles for AM Required and Responsible Department in sticky column */
        .deliverable-meta {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
            line-height: 1.3;
            white-space: normal; /* Allow wrapping */
        }
        .deliverable-meta input[type="text"],
        .deliverable-meta select {
            width: calc(100% - 10px); /* Adjust width */
            padding: 3px 5px;
            margin-top: 3px;
            margin-bottom: 3px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            font-size: 0.9em;
            box-sizing: border-box;
        }
        .deliverable-meta input[type="text"]:focus,
        .deliverable-meta select:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 1px rgba(33, 150, 243, 0.2);
        }

        /* --- Action buttons in table --- */
        .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .action-buttons .btn {
            padding: 5px 8px;
            font-size: 0.8em;
            border-radius: 3px;
        }

        .action-buttons .btn-delete {
            background-color: #f44336;
        }

        .action-buttons .btn-delete:hover {
            background-color: #d32f2f;
        }

        /* Area Column Delete Button in Table Header */
        th .area-header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 5px; /* Space between text and button */
        }
        .btn-delete-area {
            background: none;
            border: none;
            color: #888;
            font-size: 1.2em;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            transition: color 0.2s ease;
            opacity: 0; /* Hidden by default */
        }

        .project-table th:hover .btn-delete-area {
            opacity: 1; /* Show on hover of the parent th */
            color: var(--danger-color);
        }

        .btn-delete-area:hover {
            color: #c00;
        }


        /* --- Change Log --- */
        .change-log-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 15px var(--shadow-medium);
            padding: 15px;
            max-width: 350px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 100;
        }

        .change-log-container h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--secondary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }

        #changeLog {
            list-style-type: none;
            padding: 0;
            margin: 0;
            font-size: 0.85em;
        }

        #changeLog li {
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px dotted #eee;
            color: #555;
        }

        #changeLog li:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .change-log-close {
            position: absolute;
            top: 5px;
            right: 10px;
            font-size: 1.2em;
            cursor: pointer;
            color: #888;
        }
        .change-log-close:hover {
            color: #333;
        }

        /* --- Modal Styling --- */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            border-radius: 8px;
            width: 80%;
            max-width: 600px; /* Increased max-width for new modal */
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            position: relative;
        }

        .modal-content h2 {
            margin-top: 0;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .modal-content label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .modal-content input[type="text"],
        .modal-content input[type="number"], /* For AM Required */
        .modal-content select,
        .modal-content textarea { /* For comments */
            width: calc(100% - 22px); /* Account for padding and border */
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1em;
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
        }
        .modal-content textarea {
            min-height: 80px;
            resize: vertical;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 15px;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .deliverable-entry {
            border: 1px solid #eee;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
            background-color: #f9f9f9;
        }

        .deliverable-entry .deliverable-actions {
            display: flex;
            justify-content: flex-end;
            gap: 5px;
            margin-top: 10px;
        }

        .deliverable-entry .comment-section {
            background-color: #eef;
            border: 1px solid #dde;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            display: none; /* Hidden by default */
        }

        /* Responsive adjustments for modal */
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                padding: 15px;
            }
            .modal-content input[type="text"],
            .modal-content input[type="number"],
            .modal-content select,
            .modal-content textarea {
                width: calc(100% - 12px); /* Adjust for smaller padding */
            }
        }


        /* --- Print Mode --- */
        @media print {
            body {
                padding: 0;
                background-color: white;
            }
            .container {
                box-shadow: none;
                padding: 0;
                border-radius: 0;
            }
            .header, .controls, .change-log-container, .btn, .notes-icon, .section-toggle, .action-buttons, .modal, .btn-delete-area {
                display: none !important;
            }
            #projectTitle {
                font-size: 1.8em;
                text-align: center;
                margin-bottom: 20px;
                display: block;
            }
            .dashboard {
                display: block; /* Stack cards */
                margin-bottom: 20px;
            }
            .card {
                box-shadow: none;
                border: 1px solid var(--border-color);
                margin-bottom: 10px;
                text-align: left;
                display: inline-block;
                width: calc(33% - 10px); /* For 3 cards per row */
                vertical-align: top;
                margin-right: 10px;
            }
            .progress-chart {
                display: none !important; /* Hide chart in print */
            }
            .project-table {
                width: 100%;
                border-collapse: collapse;
            }
            .project-table th, .project-table td {
                border: 1px solid #ccc;
                padding: 8px 10px;
                font-size: 0.9em;
            }
            .status-dropdown, .date-input, .editable-cell {
                border: none !important;
                background-color: transparent !important;
                padding: 0 !important;
                font-size: inherit !important;
            }
            .notes-tooltip {
                visibility: visible !important;
                opacity: 1 !important;
                position: static !important;
                transform: none !important;
                background-color: #f0f0f0 !important;
                color: #555 !important;
                padding: 5px !important;
                border: 1px solid #ddd !important;
                margin-top: 5px !important;
                box-shadow: none !important;
            }
            .notes-tooltip::after {
                display: none !important;
            }
            .sticky-col {
                position: static !important;
                box-shadow: none !important;
            }
            .project-table thead th {
                position: static !important;
            }
            .section-row.collapsed + .subsection-row,
            .section-row.collapsed + .subsection-row + tr {
                display: table-row !important; /* Force display for printing */
            }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            .header-actions {
                width: 100%;
                justify-content: flex-start;
                margin-top: 15px;
            }
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            .controls .btn, .controls input, .controls select {
                width: 100%;
            }
            .change-log-container {
                left: 10px;
                right: 10px;
                max-width: unset;
            }
        }

        /* --- Connectivity Indicator --- */
        #connectivityIndicator {
            position: fixed;
            top: 18px;
            right: 18px;
            z-index: 2000;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #ccc;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 2px solid #fff;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #connectivityIndicator:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            top: 110%;
            right: 50%;
            transform: translateX(50%);
            background: #333;
            color: #fff;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.85em;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0,0,0,0.18);
            opacity: 1;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="connectivityIndicator"></div>
    <div class="container">
        <div class="header">
            <input type="text" id="projectTitle" value="My Awesome Project">
            <div class="header-actions">
                <button class="btn btn-primary" id="addAreaBtn">‚ûï Add Area Column</button>
                <button class="btn btn-secondary" id="exportExcelBtn">üìä Export to Excel</button>
                <input type="file" id="importExcelInput" accept=".xlsx, .xls" style="display: none;">
                <button class="btn btn-secondary" id="importExcelBtn">üì• Import from Excel</button>
                <button class="btn btn-outline" id="printReportBtn">üñ®Ô∏è Print Report</button>
                <button class="btn btn-danger" id="resetProjectBtn">üóëÔ∏è Reset Project</button>
            </div>
        </div>

        <div class="dashboard">
            <div class="card total">
                <div class="card-title">Total Deliverables</div>
                <div class="card-value" id="totalDeliverables">0</div>
            </div>
            <div class="card ready">
                <div class="card-title">Ready</div>
                <div class="card-value" id="readyDeliverables">0</div>
            </div>
            <div class="card in-progress">
                <div class="card-title">In Progress</div>
                <div class="card-value" id="inProgressDeliverables">0</div>
            </div>
            <div class="card overdue">
                <div class="card-title">Overdue</div>
                <div class="card-value" id="overdueDeliverables">0</div>
            </div>
            <div class="card progress-chart">
                <div class="card-title">Project Progress</div>
                <div class="chart-container">
                    <canvas id="progressDonutChart"></canvas>
                    <div class="chart-text" id="progressPercentage">0%</div>
                </div>
            </div>
        </div>

        <hr>

        <div class="controls">
            <button class="btn btn-primary" id="addSectionAndDeliverablesBtn">‚ûï Add New Section</button>
            <input type="text" id="addSubsectionInput" placeholder="New subsection name (optional)" style="display: none;">
            <button class="btn btn-secondary" id="addSubsectionBtn" style="display: none;">‚ûï Add Subsection</button>
            <input type="text" id="searchBar" placeholder="Search deliverables...">
            <select id="statusFilter">
                <option value="">All Statuses</option>
                <option value="NotStarted">Not Started</option>
                <option value="InProgress">In Progress</option>
                <option value="Review">Review</option>
                <option value="Ready">Ready</option>
                <option value="Overdue">Overdue</option>
            </select>
            <select id="departmentFilter">
                <option value="">All Departments</option>
            </select>
        </div>

        <div class="table-container">
            <table class="project-table" id="projectTable">
                <thead>
                    <tr>
                        <th class="sticky-col">Section / Deliverable</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

    <div class="change-log-container">
        <h3>Change Log</h3>
        <span class="change-log-close" id="closeChangeLog">&times;</span>
        <ul id="changeLog">
        </ul>
    </div>

    <div id="addAreaModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('addAreaModal')">&times;</span>
            <h2>Add New Area Column</h2>
            <label for="newAreaName">Area Name:</label>
            <input type="text" id="newAreaName" placeholder="e.g., Design Phase, Development, Testing">
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('addAreaModal')">Cancel</button>
                <button class="btn btn-primary" onclick="confirmAddArea()">Add Area</button>
            </div>
        </div>
    </div>

    <div id="addSectionDeliverablesModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('addSectionDeliverablesModal')">&times;</span>
            <h2>ÿ•ÿ∂ÿßŸÅÿ© ŸÇÿ≥ŸÖ ÿ¨ÿØŸäÿØ / ÿ™ÿ≥ŸÑŸäŸÖÿßÿ™</h2>

            <label for="modalSectionName">ÿßÿ≥ŸÖ ÿßŸÑŸÇÿ≥ŸÖ:</label>
            <input type="text" id="modalSectionName" placeholder="ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÇÿ≥ŸÖ ÿßŸÑÿ¨ÿØŸäÿØ">

            <label for="modalSectionNameDropdown">ÿ£Ÿà ÿßÿÆÿ™ÿ± ŸÖŸÜ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ©:</label>
            <select id="modalSectionNameDropdown">
                <option value="">-- ÿßÿÆÿ™ÿ± ŸÇÿ≥ŸÖŸãÿß ŸÖŸàÿ¨ŸàÿØŸãÿß --</option>
            </select>

            <label for="modalSubsectionName">ÿßÿ≥ŸÖ ÿßŸÑŸÇÿ≥ŸÖ ÿßŸÑŸÅÿ±ÿπŸä (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä):</label>
            <input type="text" id="modalSubsectionName" placeholder="ŸÖÿ´ÿßŸÑ: ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖŸàŸÇÿπ">

            <h3>ÿßŸÑŸÄÿ™ÿ≥ŸÑŸäŸÖÿßÿ™ (Deliverables)</h3>
            <div id="deliverablesContainer">
                </div>
            <button class="btn btn-secondary" id="addDeliverableEntryBtn">‚ûï ÿ£ÿ∂ŸÅ ÿ™ÿ≥ŸÑŸäŸÖ ÿ•ÿ∂ÿßŸÅŸä</button>

            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('addSectionDeliverablesModal')">ÿ•ŸÑÿ∫ÿßÿ°</button>
                <button class="btn btn-primary" onclick="confirmAddSectionAndDeliverables()">ÿ•ÿ∂ÿßŸÅÿ©</button>
            </div>
        </div>
    </div>

    <datalist id="departmentList"></datalist>
    <datalist id="amRequiredList"></datalist>

    <script>
        // --- Firebase Initialization ---
        const firebaseConfig = {
            apiKey: "AIzaSyBPYWUqHa6v28jt496_L6ExtXS_pqSQow4",
            authDomain: "shopping-d3ea3.firebaseapp.com",
            databaseURL: "https://shopping-d3ea3-default-rtdb.firebaseio.com",
            projectId: "shopping-d3ea3",
            storageBucket: "shopping-d3ea3.firebasestorage.app",
            messagingSenderId: "434241138137",
            appId: "1:434241138137:web:ce049431ac46db9b93fdc8",
            measurementId: "G-STYC586XED"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- Data Structure ---
        let projectData = {
            title: "My Awesome Project",
            sections: [], // Each section can contain subsections and deliverables
            areas: [], // New: Defines the columns (Areas)
            nextSectionId: 1,
            nextDeliverableId: 1,
            nextAreaId: 1 // For unique Area (column) IDs
        };

        const STATUS_OPTIONS = ["NotStarted", "InProgress", "Review", "Ready", "Overdue"];
        const SECTION_COLORS = ['#ADD8E6', '#90EE90', '#FFB6C1', '#FFDAB9', '#E6E6FA', '#FFFACD']; // LightBlue, LightGreen, LightPink, PeachPuff, Lavender, LemonChiffon
        let colorIndex = 0;

        // --- Predefined Lists ---
        const PREDEFINED_DEPARTMENTS = [
            "Project Management Department",
            "Planning & Scheduling Department",
            "Design & Engineering Department",
            "Construction Department",
            "Procurement Department",
            "Contracts Department",
            "Cost Control Department",
            "Quality Assurance & Control (QA/QC)",
            "Health, Safety & Environment (HSE)",
            "Logistics & Supply Chain Department",
            "Finance & Accounting Department",
            "Human Resources (HR) Department",
            "Legal Affairs Department",
            "IT & Systems Department",
            "Stakeholder & Communications Department",
            "Permits & Approvals Department",
            "Operations & Maintenance (O&M)",
            "Business Development Department",
            "Surveying Department",
            "Geotechnical & Soil Investigation Department"
        ];

        const AM_REQUIRED_OPTIONS = [
            "Mandatory",
            "Recommended",
            "If applicable"
        ];

        // --- DOM Elements ---
        const projectTitleInput = document.getElementById('projectTitle');
        const projectTable = document.getElementById('projectTable');
        const addAreaBtn = document.getElementById('addAreaBtn');
        const searchBar = document.getElementById('searchBar');
        const statusFilter = document.getElementById('statusFilter');
        const departmentFilter = document.getElementById('departmentFilter');
        const exportExcelBtn = document.getElementById('exportExcelBtn');
        const importExcelBtn = document.getElementById('importExcelBtn');
        const importExcelInput = document.getElementById('importExcelInput');
        const printReportBtn = document.getElementById('printReportBtn');
        const resetProjectBtn = document.getElementById('resetProjectBtn');

        // Dashboard elements
        const totalDeliverablesSpan = document.getElementById('totalDeliverables');
        const readyDeliverablesSpan = document.getElementById('readyDeliverables');
        const inProgressDeliverablesSpan = document.getElementById('inProgressDeliverables');
        const overdueDeliverablesSpan = document.getElementById('overdueDeliverables');
        const progressDonutChartCanvas = document.getElementById('progressDonutChart');
        const progressPercentageSpan = document.getElementById('progressPercentage');
        let progressChartInstance; // To store Chart.js instance

        // Change Log elements
        const changeLogList = document.getElementById('changeLog');
        const changeLogCloseBtn = document.getElementById('closeChangeLog');
        let changeLogEntries = [];
        const MAX_CHANGE_LOG_ENTRIES = 5;

        // Modals from original file
        const addAreaModal = document.getElementById('addAreaModal');
        const newAreaNameInput = document.getElementById('newAreaName');

        // NEW MODAL elements for "Add New Section"
        const addSectionDeliverablesModal = document.getElementById('addSectionDeliverablesModal');
        const addSectionAndDeliverablesBtn = document.getElementById('addSectionAndDeliverablesBtn'); // The new main button
        const modalSectionNameInput = document.getElementById('modalSectionName');
        const modalSectionNameDropdown = document.getElementById('modalSectionNameDropdown');
        const modalSubsectionNameInput = document.getElementById('modalSubsectionName');
        const deliverablesContainer = document.getElementById('deliverablesContainer');
        const addDeliverableEntryBtn = document.getElementById('addDeliverableEntryBtn');


        // --- Utility Functions ---
        // Function to get all unique departments from all deliverables
        function getAllDepartments() {
            const departments = new Set(PREDEFINED_DEPARTMENTS); // Start with predefined ones
            getAllDeliverables().forEach(d => {
                if (d.responsibleDepartment) {
                    departments.add(d.responsibleDepartment);
                }
            });
            return Array.from(departments).sort();
        }

        // Function to populate a department dropdown (used for the filter, not for individual deliverable inputs anymore)
        function populateDepartmentFilterDropdown() {
            const selectElement = departmentFilter; // Always target the filter dropdown
            selectElement.innerHTML = '';
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'All Departments';
            selectElement.appendChild(defaultOption);

            const departments = getAllDepartments();
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                selectElement.appendChild(option);
            });

            // Re-select current filter value if it exists
            const currentFilterValue = selectElement.getAttribute('data-current-filter') || '';
            if (currentFilterValue && departments.includes(currentFilterValue)) {
                selectElement.value = currentFilterValue;
            } else {
                selectElement.value = '';
            }
        }


        // --- Modal Functions (Moved to top for scope) ---
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        let deliverableEntryCounter = 0; // To give unique IDs to modal deliverable inputs

        function addDeliverableEntry(initialData = {}) {
            const index = deliverableEntryCounter++;
            const entryDiv = document.createElement('div');
            entryDiv.classList.add('deliverable-entry');
            entryDiv.setAttribute('data-index', index);
            entryDiv.innerHTML = `
                <label for="deliverableName_${index}">ÿßÿ≥ŸÖ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ:</label>
                <input type="text" id="deliverableName_${index}" class="modal-deliverable-name" placeholder="ŸÖÿ´ÿßŸÑ: Feasibility Study Report" value="${initialData.name || ''}">

                <label for="amRequired_${index}">AM Required:</label>
                <input type="text" id="amRequired_${index}" class="modal-am-required" list="amRequiredList" placeholder="ÿ£ÿØÿÆŸÑ ÿßŸÑŸÇŸäŸÖÿ©" value="${initialData.amRequired || ''}">

                <label for="responsibleDepartment_${index}">ÿßŸÑŸÇÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ§ŸàŸÑ:</label>
                <input type="text" id="responsibleDepartment_${index}" class="modal-responsible-department" list="departmentList" placeholder="ÿ£ÿØÿÆŸÑ ÿßŸÑŸÇÿ≥ŸÖ ÿ£Ÿà ÿßÿÆÿ™ÿ±Ÿá" value="${initialData.responsibleDepartment || ''}">

                <div class="deliverable-actions">
                    <button type="button" class="btn btn-outline show-comments-btn" data-index="${index}">üí¨ ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ™ÿπŸÑŸäŸÇÿßÿ™</button>
                    <button type="button" class="btn btn-danger remove-deliverable-entry-btn">ÿ≠ÿ∞ŸÅ</button>
                </div>
                <div class="comment-section">
                    <label for="comments_${index}">ÿßŸÑÿ™ÿπŸÑŸäŸÇÿßÿ™:</label>
                    <textarea id="comments_${index}" class="modal-deliverable-comments" placeholder="ÿ£ÿØÿÆŸÑ ÿ™ÿπŸÑŸäŸÇÿßÿ™ ŸáŸÜÿß...">${initialData.notes || ''}</textarea>
                </div>
            `;
            deliverablesContainer.appendChild(entryDiv);

            // Add event listener for "Show Comments" button
            entryDiv.querySelector('.show-comments-btn').addEventListener('click', (e) => {
                const commentSection = e.target.closest('.deliverable-actions').nextElementSibling;
                commentSection.style.display = commentSection.style.display === 'block' ? 'none' : 'block';
            });

            // Add event listener for "Remove" button
            entryDiv.querySelector('.remove-deliverable-entry-btn').addEventListener('click', (e) => {
                e.target.closest('.deliverable-entry').remove();
            });
        }


        function showAddSectionDeliverablesModal() {
            // Clear previous inputs
            modalSectionNameInput.value = '';
            modalSubsectionNameInput.value = '';
            deliverablesContainer.innerHTML = '';
            addDeliverableEntry(); // Add one empty deliverable entry by default

            // Populate Section Name Dropdown
            modalSectionNameDropdown.innerHTML = '<option value="">-- ÿßÿÆÿ™ÿ± ŸÇÿ≥ŸÖŸãÿß ŸÖŸàÿ¨ŸàÿØŸãÿß --</option>';
            projectData.sections.forEach(section => {
                const option = document.createElement('option');
                option.value = section.name;
                option.textContent = section.name;
                modalSectionNameDropdown.appendChild(option);
            });

            // Handle dropdown change: if a section is selected, clear text input
            modalSectionNameDropdown.onchange = () => {
                if (modalSectionNameDropdown.value !== "") {
                    modalSectionNameInput.value = ""; // Clear manual input if dropdown is used
                }
            };

            // Handle text input change: if text is entered, reset dropdown
            modalSectionNameInput.onkeyup = () => {
                if (modalSectionNameInput.value !== "") {
                    modalSectionNameDropdown.value = ""; // Clear dropdown if manual input is used
                }
            };

            showModal('addSectionDeliverablesModal');
        }

        function confirmAddSectionAndDeliverables() {
            const sectionName = modalSectionNameInput.value.trim() || modalSectionNameDropdown.value.trim();
            const subsectionName = modalSubsectionNameInput.value.trim();
            const deliverableEntries = Array.from(deliverablesContainer.querySelectorAll('.deliverable-entry'));

            if (!sectionName && deliverableEntries.length === 0) {
                alert("ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÇÿ≥ŸÖ ÿ£Ÿà ÿ•ÿ∂ÿßŸÅÿ© ÿ™ÿ≥ŸÑŸäŸÖ Ÿàÿßÿ≠ÿØ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ.");
                return;
            }

            let targetSection = projectData.sections.find(s => s.name === sectionName);
            let isNewSection = false;

            if (!targetSection) {
                isNewSection = true;
                targetSection = {
                    id: `s${projectData.nextSectionId++}`,
                    name: sectionName,
                    type: "section",
                    color: SECTION_COLORS[colorIndex++ % SECTION_COLORS.length],
                    isCollapsed: false,
                    children: []
                };
                projectData.sections.push(targetSection);
                addChangeLogEntry(`ÿ™ŸÖÿ™ ÿ•ÿ∂ÿßŸÅÿ© ŸÇÿ≥ŸÖ ÿ¨ÿØŸäÿØ: "${sectionName}"`);
            }

            let parentForDeliverables = targetSection.children;

            if (subsectionName) {
                // Check if subsection already exists within this section
                let targetSubsection = targetSection.children.find(
                    child => child.type === 'subsection' && child.name === subsectionName
                );
                if (!targetSubsection) {
                    targetSubsection = {
                        id: `sub${projectData.nextSectionId++}`,
                        name: subsectionName,
                        type: "subsection",
                        children: []
                    };
                    targetSection.children.push(targetSubsection);
                    addChangeLogEntry(`ÿ™ŸÖÿ™ ÿ•ÿ∂ÿßŸÅÿ© ŸÇÿ≥ŸÖ ŸÅÿ±ÿπŸä "${subsectionName}" ÿ•ŸÑŸâ ÿßŸÑŸÇÿ≥ŸÖ "${sectionName}"`);
                }
                parentForDeliverables = targetSubsection.children;
            }

            deliverableEntries.forEach(entry => {
                const delivName = entry.querySelector('.modal-deliverable-name').value.trim();
                const amRequired = entry.querySelector('.modal-am-required').value.trim();
                const responsibleDept = entry.querySelector('.modal-responsible-department').value.trim();
                const comments = entry.querySelector('.modal-deliverable-comments').value.trim();

                if (delivName) {
                    const newDeliverable = {
                        id: `d${projectData.nextDeliverableId++}`,
                        name: delivName,
                        type: "deliverable",
                        amRequired: amRequired, // Now directly on deliverable
                        responsibleDepartment: responsibleDept, // Now directly on deliverable
                        notes: comments, // Now directly on deliverable
                        areaData: {} // Area data remains for status/due date
                    };

                    projectData.areas.forEach(area => {
                        newDeliverable.areaData[area.id] = {
                            status: "NotStarted",
                            dueDate: ""
                            // notes, responsibleDepartment, amRequired are now on the deliverable itself
                        };
                    });
                    parentForDeliverables.push(newDeliverable);
                    addChangeLogEntry(`ÿ™ŸÖÿ™ ÿ•ÿ∂ÿßŸÅÿ© ÿ™ÿ≥ŸÑŸäŸÖ "${delivName}"`);
                }
            });

            saveProjectData();
            renderTable();
            closeModal('addSectionDeliverablesModal');
        }

        function showAddAreaModal() {
            newAreaNameInput.value = '';
            showModal('addAreaModal');
        }

        function confirmAddArea() {
            const areaName = newAreaNameInput.value.trim();
            if (areaName) {
                const newAreaId = `area_col_${projectData.nextAreaId++}`;
                projectData.areas.push({ id: newAreaId, name: areaName });

                // Initialize this new area's data for all existing deliverables
                projectData.sections.forEach(sec => {
                    function initializeNewAreaForChildren(item) {
                        if (item.type === 'deliverable') {
                            if (!item.areaData) item.areaData = {};
                            item.areaData[newAreaId] = { status: "NotStarted", dueDate: "" }; // Only status and due date here
                        }
                        if (item.children) {
                            item.children.forEach(child => initializeNewAreaForChildren(child));
                        }
                    }
                    initializeNewAreaForChildren(sec);
                });

                addChangeLogEntry(`Added new area column: "${areaName}"`);
                saveProjectData();
                renderTable();
                closeModal('addAreaModal');
            } else {
                alert("Please enter a name for the new area.");
            }
        }


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            populateDatalists(); // Populate datalists first
            loadProjectData();
            renderTable();
            setupEventListeners();
            // Initially add one deliverable entry to the new modal
            addDeliverableEntry();
        });

        // Add Chart.js library dynamically
        let chartJsLoaded = false;
        const script = document.createElement('script');
        script.src = "https://cdn.jsdelivr.net/npm/chart.js";
        script.onload = () => {
            chartJsLoaded = true;
            updateDashboard();
        };
        document.head.appendChild(script);

        // --- Local Storage Management (Fall back if Firebase fails or for initial load) ---
        function saveProjectDataLocal() {
            localStorage.setItem('projectDeliverablesData', JSON.stringify(projectData));
            updateDashboard();
            populateDepartmentFilterDropdown(); // Use the filter population function
        }

        function loadProjectDataLocal() {
            const storedData = localStorage.getItem('projectDeliverablesData');
            if (storedData) {
                projectData = JSON.parse(storedData);
                // Ensure default values if not present in old data
                if (!projectData.title) projectData.title = "My Awesome Project";
                if (!projectData.sections) projectData.sections = [];
                if (!projectData.areas) projectData.areas = []; // Initialize areas if not present
                if (!projectData.nextSectionId) projectData.nextSectionId = 1;
                if (!projectData.nextDeliverableId) projectData.nextDeliverableId = 1;
                if (!projectData.nextAreaId) projectData.nextAreaId = 1;

                // --- IMPORTANT FIX: Ensure areaData is an object for all deliverables on load ---
                projectData.sections.forEach(sec => {
                    ensureDeliverableDataInitialized(sec); // Changed name to reflect deliverable-level properties
                });
                projectTitleInput.value = projectData.title;
            } else {
                // Initialize with some default sections/deliverables if no data exists
                initializeDefaultData();
            }
            populateDepartmentFilterDropdown(); // Use the filter population function
        }


        // --- Save to Firebase ---
        function saveProjectData() {
            try {
                db.ref('projects/main').set(projectData, (error) => {
                    if (error) {
                        console.error("Firebase save failed, falling back to local storage:", error);
                        saveProjectDataLocal();
                        addChangeLogEntry("Data saved locally (Firebase error).", "warning");
                        updateConnectivityIndicator(false); // Indicate offline/error
                    } else {
                        console.log("Data saved to Firebase.");
                        updateDashboard();
                        populateDepartmentFilterDropdown(); // Use the filter population function
                        addChangeLogEntry("Data saved to cloud.", "success");
                        updateConnectivityIndicator(true); // Indicate connected
                    }
                });
            } catch (e) {
                console.error("Firebase operation failed, falling back to local storage:", e);
                saveProjectDataLocal();
                addChangeLogEntry("Data saved locally (Firebase error).", "warning");
                updateConnectivityIndicator(false); // Indicate offline/error
            }
        }

        // --- Load from Firebase ---
        function loadProjectData() {
            db.ref('projects/main').once('value')
                .then(snapshot => {
                    const data = snapshot.val();
                    if (data) {
                        projectData = data;
                        // Ensure default values for new properties in old data
                        if (!projectData.title) projectData.title = "My Awesome Project";
                        if (!projectData.sections) projectData.sections = [];
                        if (!projectData.areas) projectData.areas = [];
                        if (!projectData.nextSectionId) projectData.nextSectionId = 1;
                        if (!projectData.nextDeliverableId) projectData.nextDeliverableId = 1;
                        if (!projectData.nextAreaId) projectData.nextAreaId = 1;

                        // Recursive fix for older data structures
                        projectData.sections.forEach(sec => {
                            ensureDeliverableDataInitialized(sec);
                        });

                        projectTitleInput.value = projectData.title;
                        populateDepartmentFilterDropdown(); // Use the filter population function
                        addChangeLogEntry("Data loaded from cloud.", "info");
                        updateConnectivityIndicator(true); // Indicate connected
                    } else {
                        console.log("No data in Firebase, loading from local storage.");
                        loadProjectDataLocal();
                        addChangeLogEntry("No cloud data, loaded from local.", "info");
                        updateConnectivityIndicator(true); // If local load is fallback, assume connectivity is fine, or it will be checked below
                    }
                })
                .catch(error => {
                    console.error("Firebase load failed, falling back to local storage:", error);
                    loadProjectDataLocal();
                    addChangeLogEntry("Failed to load from cloud, loaded from local.", "error");
                    updateConnectivityIndicator(false); // Indicate offline/error
                });
        }

        // Recursive helper to ensure deliverable properties and areaData are initialized
        function ensureDeliverableDataInitialized(item) {
            if (item.type === 'deliverable') {
                // Ensure deliverable-level properties exist
                if (item.amRequired === undefined) item.amRequired = '';
                if (item.responsibleDepartment === undefined) item.responsibleDepartment = '';
                if (item.notes === undefined) item.notes = '';

                // Ensure areaData exists for all defined areas
                if (!item.areaData) item.areaData = {};
                projectData.areas.forEach(area => {
                    if (!item.areaData[area.id]) {
                        item.areaData[area.id] = { status: "NotStarted", dueDate: "" };
                    }
                });
            }
            if (item.children) {
                item.children.forEach(child => ensureDeliverableDataInitialized(child));
            }
        }


        function initializeDefaultData() {
            projectData = {
                title: "My Awesome Project",
                sections: [
                    {
                        id: 's1', name: "Phase 1: Planning", type: "section", color: SECTION_COLORS[0], isCollapsed: false, children: [
                            {
                                id: 'd1', name: "Project Charter", type: "deliverable", amRequired: "Mandatory", responsibleDepartment: "Project Management Department", notes: "Initial draft submitted", areaData: {
                                    area_col_1: { status: "Ready", dueDate: "2024-07-30" },
                                    area_col_2: { status: "NotStarted", dueDate: "" }
                                }
                            },
                            {
                                id: 'd2', name: "Stakeholder Register", type: "deliverable", amRequired: "Recommended", responsibleDepartment: "Stakeholder & Communications Department", notes: "", areaData: {
                                    area_col_1: { status: "InProgress", dueDate: "2024-08-05" },
                                    area_col_2: { status: "NotStarted", dueDate: "" }
                                }
                            },
                            {
                                id: 'sub1', name: "Requirement Gathering", type: "subsection", children: [
                                    {
                                        id: 'd3', name: "Business Requirements Document (BRD)", type: "deliverable", amRequired: "Mandatory", responsibleDepartment: "Design & Engineering Department", notes: "Awaiting client sign-off", areaData: {
                                            area_col_1: { status: "Review", dueDate: "2024-07-25" },
                                            area_col_2: { status: "InProgress", dueDate: "2024-09-01" }
                                        }
                                    },
                                    {
                                        id: 'd4', name: "Functional Specification Document (FSD)", type: "deliverable", amRequired: "If applicable", responsibleDepartment: "IT & Systems Department", notes: "", areaData: {
                                            area_col_1: { status: "InProgress", dueDate: "2024-08-15" },
                                            area_col_2: { status: "NotStarted", dueDate: "" }
                                        }
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        id: 's2', name: "Phase 2: Execution", type: "section", color: SECTION_COLORS[1], isCollapsed: false, children: [
                            {
                                id: 'd5', name: "System Design Document", type: "deliverable", amRequired: "Mandatory", responsibleDepartment: "Design & Engineering Department", notes: "Review with dev team", areaData: {
                                    area_col_1: { status: "InProgress", dueDate: "2024-08-30" },
                                    area_col_2: { status: "InProgress", dueDate: "2024-10-01" }
                                }
                            },
                            {
                                id: 'd6', name: "Module Development Complete", type: "deliverable", amRequired: "Mandatory", responsibleDepartment: "Construction Department", notes: "Started coding for module A", areaData: {
                                    area_col_1: { status: "InProgress", dueDate: "2024-09-15" },
                                    area_col_2: { status: "NotStarted", dueDate: "" }
                                }
                            }
                        ]
                    }
                ],
                areas: [{ id: 'area_col_1', name: 'Original Area' }, { id: 'area_col_2', name: 'New Area' }],
                nextSectionId: 3,
                nextDeliverableId: 7,
                nextAreaId: 3 // Start from 3 as 1 and 2 are used for default areas
            };
            addChangeLogEntry("Default project data loaded.");
            saveProjectData(); // Save to Firebase/Local after initializing defaults
        }


        // --- Render Table ---
        function renderTable() {
            const tbody = projectTable.querySelector('tbody');
            const theadRow = projectTable.querySelector('thead tr');
            tbody.innerHTML = ''; // Clear existing rows

            // Clear and rebuild headers (for dynamic area columns)
            theadRow.innerHTML = '';
            theadRow.innerHTML += `<th class="sticky-col">Section / Deliverable</th>`;
            projectData.areas.forEach(area => {
                theadRow.innerHTML += `
                    <th>
                        <div class="area-header-content">
                            <span>${area.name}</span>
                            <button class="btn-delete-area" data-area-id="${area.id}" title="Delete Area Column">&times;</button>
                        </div>
                    </th>`;
            });
            theadRow.innerHTML += `<th>Actions</th>`; // Add actions header

            const allDeliverables = getAllDeliverables();
            const currentDepartmentFilter = departmentFilter.value;
            const currentStatusFilter = statusFilter.value;
            const searchTerm = searchBar.value.toLowerCase();

            projectData.sections.forEach(section => {
                let sectionHasVisibleDeliverables = false;
                // Check if any deliverable within this section (or its subsections) matches filters
                const checkChildrenForVisibility = (children) => {
                    return children.some(item => {
                        if (item.type === 'deliverable') {
                            const matchesSearch = searchTerm === '' || item.name.toLowerCase().includes(searchTerm) || item.notes.toLowerCase().includes(searchTerm) || item.responsibleDepartment.toLowerCase().includes(searchTerm) || item.amRequired.toLowerCase().includes(searchTerm);
                            const matchesDepartment = currentDepartmentFilter === '' || item.responsibleDepartment === currentDepartmentFilter;
                            // Check if any areaData for the deliverable matches the status filter
                            const matchesStatus = currentStatusFilter === '' ||
                                Object.values(item.areaData || {}).some(ad => ad.status === currentStatusFilter);

                            return matchesSearch && matchesDepartment && matchesStatus;
                        } else if (item.type === 'subsection' && item.children) {
                            return checkChildrenForVisibility(item.children);
                        }
                        return false;
                    });
                };

                sectionHasVisibleDeliverables = checkChildrenForVisibility(section.children);

                // If section has no visible deliverables, skip rendering it
                if (!sectionHasVisibleDeliverables && (searchTerm || currentDepartmentFilter || currentStatusFilter)) {
                    return;
                }

                // Section Row
                const sectionRow = document.createElement('tr');
                sectionRow.classList.add('section-row');
                if (section.isCollapsed) {
                    sectionRow.classList.add('collapsed');
                }
                sectionRow.setAttribute('data-section-id', section.id);
                sectionRow.style.backgroundColor = section.color;
                sectionRow.innerHTML = `
                    <td class="sticky-col section-name-cell" colspan="${2 + projectData.areas.length}">
                        <span class="section-toggle"></span>
                        <span class="section-badge" style="background-color: ${section.color};"></span>
                        <input type="text" value="${section.name}" class="editable-cell section-name-input" data-id="${section.id}" data-type="section">
                    </td>
                `;
                tbody.appendChild(sectionRow);

                // Render children (subsections and deliverables)
                renderChildren(section.children, tbody, section.isCollapsed, 1); // Indent level 1
            });

            addTableEventListeners(); // Attach event listeners after rendering
            updateDashboard(); // Update dashboard after table re-render
        }

        function renderChildren(children, parentElement, parentCollapsed, indentLevel) {
            children.forEach(item => {
                if (item.type === 'subsection') {
                    let subsectionHasVisibleDeliverables = false;
                    const currentDepartmentFilter = departmentFilter.value;
                    const currentStatusFilter = statusFilter.value;
                    const searchTerm = searchBar.value.toLowerCase();

                    const checkChildrenForVisibility = (children) => {
                        return children.some(child => {
                            if (child.type === 'deliverable') {
                                const matchesSearch = searchTerm === '' || child.name.toLowerCase().includes(searchTerm) || child.notes.toLowerCase().includes(searchTerm) || child.responsibleDepartment.toLowerCase().includes(searchTerm) || child.amRequired.toLowerCase().includes(searchTerm);
                                const matchesDepartment = currentDepartmentFilter === '' || child.responsibleDepartment === currentDepartmentFilter;
                                const matchesStatus = currentStatusFilter === '' ||
                                    Object.values(child.areaData || {}).some(ad => ad.status === currentStatusFilter);
                                return matchesSearch && matchesDepartment && matchesStatus;
                            }
                            return false;
                        });
                    };

                    subsectionHasVisibleDeliverables = checkChildrenForVisibility(item.children);

                    if (!subsectionHasVisibleDeliverables && (searchTerm || currentDepartmentFilter || currentStatusFilter)) {
                        return;
                    }

                    const subsectionRow = document.createElement('tr');
                    subsectionRow.classList.add('subsection-row');
                    if (parentCollapsed) {
                        subsectionRow.style.display = 'none'; // Hide if parent section is collapsed
                    }
                    subsectionRow.setAttribute('data-subsection-id', item.id);
                    subsectionRow.innerHTML = `
                        <td class="sticky-col" colspan="${2 + projectData.areas.length}" style="padding-left: ${20 + (indentLevel * 20)}px;">
                            <input type="text" value="${item.name}" class="editable-cell subsection-name-input" data-id="${item.id}" data-type="subsection">
                        </td>
                    `;
                    parentElement.appendChild(subsectionRow);
                    renderChildren(item.children, parentElement, parentCollapsed, indentLevel + 1); // Recurse for deliverables in subsection
                } else if (item.type === 'deliverable') {
                    const currentDepartmentFilter = departmentFilter.value;
                    const currentStatusFilter = statusFilter.value;
                    const searchTerm = searchBar.value.toLowerCase();

                    const matchesSearch = searchTerm === '' ||
                        item.name.toLowerCase().includes(searchTerm) ||
                        item.notes.toLowerCase().includes(searchTerm) ||
                        item.responsibleDepartment.toLowerCase().includes(searchTerm) ||
                        item.amRequired.toLowerCase().includes(searchTerm);

                    const matchesDepartment = currentDepartmentFilter === '' || item.responsibleDepartment === currentDepartmentFilter;
                    const matchesStatus = currentStatusFilter === '' ||
                        Object.values(item.areaData || {}).some(ad => ad.status === currentStatusFilter);


                    if (!matchesSearch || !matchesDepartment || !matchesStatus) {
                        return; // Skip rendering if filters don't match
                    }

                    const deliverableRow = document.createElement('tr');
                    if (parentCollapsed) {
                        deliverableRow.style.display = 'none'; // Hide if parent section is collapsed
                    }
                    deliverableRow.setAttribute('data-deliverable-id', item.id);

                    const today = new Date();
                    today.setHours(0, 0, 0, 0); // Reset time for accurate date comparison

                    let isOverdueInAnyArea = false;
                    projectData.areas.forEach(area => {
                        const areaInfo = item.areaData[area.id];
                        if (areaInfo && areaInfo.status !== 'Ready' && areaInfo.dueDate) {
                            const dueDate = new Date(areaInfo.dueDate);
                            dueDate.setHours(0, 0, 0, 0);
                            if (dueDate < today) {
                                isOverdueInAnyArea = true;
                            }
                        }
                    });

                    if (isOverdueInAnyArea) {
                        deliverableRow.classList.add('overdue-deliverable');
                    }

                    let cellsHtml = `
                        <td class="sticky-col" style="padding-left: ${20 + (indentLevel * 20)}px;">
                            <input type="text" value="${item.name}" class="editable-cell deliverable-name-input" data-id="${item.id}" data-type="deliverable-name">
                            <div class="deliverable-meta">
                                <div>AM Required: <input type="text" value="${item.amRequired}" class="editable-cell am-required-input" data-id="${item.id}" data-type="am-required" list="amRequiredList"></div>
                                <div>Responsible Dept: <input type="text" value="${item.responsibleDepartment}" class="editable-cell responsible-department-input" data-id="${item.id}" data-type="responsible-department" list="departmentList"></div>
                                ${item.notes ? `<span class="notes-icon">i<span class="notes-tooltip">${item.notes}</span></span>` : ''}
                            </div>
                        </td>
                    `;

                    projectData.areas.forEach(area => {
                        const areaInfo = item.areaData[area.id] || { status: "NotStarted", dueDate: "" };
                        const isAreaOverdue = areaInfo.status !== 'Ready' && areaInfo.dueDate && (new Date(areaInfo.dueDate).setHours(0,0,0,0) < today.setHours(0,0,0,0));
                        cellsHtml += `
                            <td>
                                <select class="status-dropdown ${areaInfo.status}" data-id="${item.id}" data-area-id="${area.id}" data-type="status">
                                    ${STATUS_OPTIONS.map(status => `<option value="${status}" ${areaInfo.status === status ? 'selected' : ''} class="${status}">${status}</option>`).join('')}
                                </select>
                                <input type="date" value="${areaInfo.dueDate}" class="date-input ${isAreaOverdue ? 'overdue-date-input' : ''}" data-id="${item.id}" data-area-id="${area.id}" data-type="due-date">
                                ${isAreaOverdue ? '<span class="overdue-message">Date Overdue!</span>' : ''}
                            </td>
                        `;
                    });

                    cellsHtml += `
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-danger btn-delete" data-id="${item.id}" data-type="deliverable">Delete</button>
                            </div>
                        </td>
                    `;
                    deliverableRow.innerHTML = cellsHtml;
                    parentElement.appendChild(deliverableRow);
                }
            });
        }


        function addTableEventListeners() {
            // Section toggle
            document.querySelectorAll('.section-toggle').forEach(toggle => {
                toggle.onclick = (e) => {
                    const sectionRow = e.target.closest('.section-row');
                    const sectionId = sectionRow.getAttribute('data-section-id');
                    const section = projectData.sections.find(s => s.id === sectionId);

                    if (section) {
                        section.isCollapsed = !section.isCollapsed;
                        sectionRow.classList.toggle('collapsed', section.isCollapsed);

                        let nextSibling = sectionRow.nextElementSibling;
                        while (nextSibling && (nextSibling.classList.contains('subsection-row') || nextSibling.getAttribute('data-deliverable-id'))) {
                            nextSibling.style.display = section.isCollapsed ? 'none' : 'table-row';
                            nextSibling = nextSibling.nextElementSibling;
                        }
                        saveProjectData();
                    }
                };
            });


            // Editable cells (inputs/selects)
            document.querySelectorAll('.editable-cell, .status-dropdown, .date-input').forEach(input => {
                input.onchange = (e) => {
                    const target = e.target;
                    const id = target.getAttribute('data-id');
                    const type = target.getAttribute('data-type');
                    const areaId = target.getAttribute('data-area-id'); // Only for status/date
                    const value = target.value;

                    // Find the deliverable or section/subsection
                    let found = false;
                    projectData.sections.forEach(sec => {
                        if (sec.id === id && type === 'section') {
                            addChangeLogEntry(`Section "${sec.name}" renamed to "${value}".`);
                            sec.name = value;
                            found = true;
                            return;
                        }
                        // Recursive search for deliverables and subsections
                        const findAndUpdate = (children) => {
                            children.forEach(item => {
                                if (item.id === id) {
                                    if (type === 'subsection') {
                                        addChangeLogEntry(`Subsection "${item.name}" renamed to "${value}".`);
                                        item.name = value;
                                        found = true;
                                    } else if (item.type === 'deliverable') {
                                        if (type === 'deliverable-name') {
                                            addChangeLogEntry(`Deliverable "${item.name}" renamed to "${value}".`);
                                            item.name = value;
                                            found = true;
                                        } else if (type === 'am-required') {
                                            addChangeLogEntry(`AM Required for "${item.name}" changed to "${value}".`);
                                            item.amRequired = value;
                                            found = true;
                                        } else if (type === 'responsible-department') {
                                            addChangeLogEntry(`Responsible Department for "${item.name}" changed to "${value}".`);
                                            item.responsibleDepartment = value;
                                            found = true;
                                        } else if (type === 'status' && areaId) {
                                            const oldStatus = item.areaData[areaId].status;
                                            addChangeLogEntry(`Status for "${item.name}" in "${projectData.areas.find(a => a.id === areaId).name}" changed from "${oldStatus}" to "${value}".`);
                                            item.areaData[areaId].status = value;
                                            found = true;
                                        } else if (type === 'due-date' && areaId) {
                                            const oldDate = item.areaData[areaId].dueDate;
                                            addChangeLogEntry(`Due Date for "${item.name}" in "${projectData.areas.find(a => a.id === areaId).name}" changed from "${oldDate}" to "${value}".`);
                                            item.areaData[areaId].dueDate = value;
                                            found = true;
                                        }
                                    }
                                    if (found) return; // Stop searching once found
                                }
                                if (item.children && !found) {
                                    findAndUpdate(item.children);
                                }
                            });
                        };
                        if (!found) findAndUpdate(sec.children);
                    });
                    saveProjectData();
                    renderTable(); // Re-render to update any overdue highlighting etc.
                };
            });

            // Delete buttons (for deliverables)
            document.querySelectorAll('.btn-delete').forEach(button => {
                button.onclick = (e) => {
                    if (confirm("Are you sure you want to delete this item?")) {
                        const idToDelete = e.target.getAttribute('data-id');
                        const typeToDelete = e.target.getAttribute('data-type');

                        if (typeToDelete === 'deliverable') {
                            projectData.sections.forEach(sec => {
                                sec.children = sec.children.filter(item => {
                                    if (item.id === idToDelete) {
                                        addChangeLogEntry(`Deleted deliverable: "${item.name}"`);
                                        return false;
                                    }
                                    if (item.type === 'subsection' && item.children) {
                                        item.children = item.children.filter(subItem => {
                                            if (subItem.id === idToDelete) {
                                                addChangeLogEntry(`Deleted deliverable: "${subItem.name}"`);
                                                return false;
                                            }
                                            return true;
                                        });
                                    }
                                    return true;
                                });
                            });
                        }
                        saveProjectData();
                        renderTable();
                    }
                };
            });

            // NEW: Delete Area Column button
            document.querySelectorAll('.btn-delete-area').forEach(button => {
                button.onclick = (e) => {
                    const areaId = e.target.getAttribute('data-area-id');
                    deleteAreaColumn(areaId);
                };
            });
        }

        // NEW: Function to delete an Area Column
        function deleteAreaColumn(areaIdToDelete) {
            const areaToDelete = projectData.areas.find(area => area.id === areaIdToDelete);
            if (!areaToDelete) {
                console.warn(`Area with ID ${areaIdToDelete} not found.`);
                return;
            }

            if (!confirm(`Are you sure you want to delete the column "${areaToDelete.name}"? This will also remove all associated status and due date data for this column from all deliverables.`)) {
                return;
            }

            // Remove the area from the projectData.areas array
            projectData.areas = projectData.areas.filter(area => area.id !== areaIdToDelete);

            // Recursively remove the areaData for this column from all deliverables
            function removeAreaFromDeliverables(items) {
                items.forEach(item => {
                    if (item.type === 'deliverable' && item.areaData) {
                        delete item.areaData[areaIdToDelete];
                    }
                    if (item.children) {
                        removeAreaFromDeliverables(item.children);
                    }
                });
            }
            projectData.sections.forEach(section => removeAreaFromDeliverables([section])); // Pass section in an array to start recursion

            addChangeLogEntry(`Deleted area column: "${areaToDelete.name}"`);
            saveProjectData();
            renderTable();
            alert(`Column "${areaToDelete.name}" and its data have been deleted successfully.`);
        }


        // --- Dashboard & Stats ---
        function getAllDeliverables() {
            const deliverables = [];
            projectData.sections.forEach(section => {
                function traverse(item) {
                    if (item.type === 'deliverable') {
                        deliverables.push(item);
                    }
                    if (item.children) {
                        item.children.forEach(child => traverse(child));
                    }
                }
                traverse(section);
            });
            return deliverables;
        }

        function calculateDashboardStats() {
            const allDeliverables = getAllDeliverables();
            let total = allDeliverables.length;
            let ready = 0;
            let inProgress = 0;
            let overdue = 0;
            let totalAreasTracked = 0; // Number of status/due date entries across all deliverables/areas
            let readyAreaEntries = 0; // Number of 'Ready' status entries

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            allDeliverables.forEach(deliverable => {
                let isDeliverableOverdue = false;
                
                // Track if deliverable has any 'InProgress' or 'Review' status across its areas
                let hasInProgressOrReview = false; 

                if (deliverable.areaData) {
                    Object.values(deliverable.areaData).forEach(areaInfo => {
                        totalAreasTracked++;
                        if (areaInfo.status === 'Ready') {
                            readyAreaEntries++;
                        } else if (areaInfo.status === 'InProgress' || areaInfo.status === 'Review') {
                            hasInProgressOrReview = true;
                        }

                        if (areaInfo.status !== 'Ready' && areaInfo.dueDate) {
                            const dueDate = new Date(areaInfo.dueDate);
                            dueDate.setHours(0, 0, 0, 0);
                            if (dueDate < today) {
                                isDeliverableOverdue = true;
                            }
                        }
                    });
                }
                
                // Determine deliverable status for dashboard counts
                const deliverableStatuses = Object.values(deliverable.areaData || {}).map(ad => ad.status);

                // A deliverable is 'Ready' for dashboard if ALL its areaData entries are 'Ready'
                if (deliverableStatuses.length > 0 && deliverableStatuses.every(status => status === 'Ready')) {
                    ready++;
                } else if (hasInProgressOrReview) { // If not fully Ready, but has InProgress/Review
                    inProgress++;
                }
                
                // A deliverable is 'Overdue' if any of its areaData entries are overdue (and not 'Ready' for that specific area)
                if (isDeliverableOverdue) {
                    overdue++;
                }
            });

            // Calculate overall project progress based on 'Ready' area entries
            const overallProgressPercentage = totalAreasTracked > 0 ? (readyAreaEntries / totalAreasTracked) * 100 : 0;

            return {
                total,
                ready,
                inProgress,
                overdue,
                overallProgressPercentage: overallProgressPercentage.toFixed(1) // One decimal place
            };
        }


        function updateDashboard() {
            const stats = calculateDashboardStats();
            totalDeliverablesSpan.textContent = stats.total;
            readyDeliverablesSpan.textContent = stats.ready;
            inProgressDeliverablesSpan.textContent = stats.inProgress;
            overdueDeliverablesSpan.textContent = stats.overdue;
            progressPercentageSpan.textContent = `${stats.overallProgressPercentage}%`;

            if (chartJsLoaded) {
                renderDonutChart(stats.readyAreaEntries, stats.totalAreasTracked - stats.readyAreaEntries); // Use specific counts for chart
            }
        }

        // Modified renderDonutChart to use `readyAreaEntries` and `totalAreasTracked`
        function renderDonutChart(readyAreaEntriesCount, otherAreaEntriesCount) {
            const ctx = progressDonutChartCanvas.getContext('2d');

            if (progressChartInstance) {
                progressChartInstance.destroy(); // Destroy previous chart instance
            }

            progressChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Ready Areas', 'Other Areas'],
                    datasets: [{
                        data: [readyAreaEntriesCount, otherAreaEntriesCount],
                        backgroundColor: [
                            'var(--primary-color)', // Ready
                            '#ccc' // Other
                        ],
                        borderColor: [
                            'white',
                            'white'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%', // Make it a donut chart
                    plugins: {
                        legend: {
                            display: false // Hide legend
                        },
                        tooltip: {
                            enabled: false // Hide tooltips on hover
                        }
                    }
                }
            });
        }


        // --- Filtering ---
        function populateDepartmentFilter() {
            // Store the current selection before clearing
            const currentSelectedDepartment = departmentFilter.value;

            const departments = new Set();
            getAllDeliverables().forEach(d => {
                if (d.responsibleDepartment) {
                    departments.add(d.responsibleDepartment);
                }
            });

            // Also add predefined departments to the filter dropdown options
            PREDEFINED_DEPARTMENTS.forEach(dept => departments.add(dept));


            departmentFilter.innerHTML = '<option value="">All Departments</option>';
            Array.from(departments).sort().forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                departmentFilter.appendChild(option);
            });

            // Restore previous selection
            departmentFilter.value = currentSelectedDepartment;
        }


        function filterTable() {
            renderTable(); // Re-render table to apply filters
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            projectTitleInput.onchange = (e) => {
                addChangeLogEntry(`Project title changed from "${projectData.title}" to "${e.target.value}".`);
                projectData.title = e.target.value;
                saveProjectData();
            };

            addAreaBtn.onclick = showAddAreaModal;
            addSectionAndDeliverablesBtn.onclick = showAddSectionDeliverablesModal; // New button for new modal
            addDeliverableEntryBtn.onclick = () => addDeliverableEntry(); // For adding more deliverables in the modal

            searchBar.onkeyup = filterTable;
            statusFilter.onchange = filterTable;
            departmentFilter.onchange = filterTable;

            exportExcelBtn.onclick = exportToExcel;
            importExcelBtn.onclick = () => importExcelInput.click();
            importExcelInput.onchange = importFromExcel;
            printReportBtn.onclick = () => window.print();
            resetProjectBtn.onclick = resetProject;

            changeLogCloseBtn.onclick = () => {
                document.querySelector('.change-log-container').style.display = 'none';
            };

            // Connectivity Indicator hover
            const connectivityIndicator = document.getElementById('connectivityIndicator');
            connectivityIndicator.onmouseover = () => {
                if (navigator.onLine) {
                    connectivityIndicator.setAttribute('data-tooltip', 'Online (Connected)');
                } else {
                    connectivityIndicator.setAttribute('data-tooltip', 'Offline (No Internet)');
                }
            };

            // Initial connectivity check
            fetchConnectivityStatus();
            setInterval(fetchConnectivityStatus, 5000); // Check every 5 seconds
            window.addEventListener('online', fetchConnectivityStatus);
            window.addEventListener('offline', fetchConnectivityStatus);
        }

        // --- Populate Datalists ---
        function populateDatalists() {
            const departmentDatalist = document.getElementById('departmentList');
            departmentDatalist.innerHTML = '';
            PREDEFINED_DEPARTMENTS.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                departmentDatalist.appendChild(option);
            });

            const amRequiredDatalist = document.getElementById('amRequiredList');
            amRequiredDatalist.innerHTML = '';
            AM_REQUIRED_OPTIONS.forEach(optionText => {
                const option = document.createElement('option');
                option.value = optionText;
                amRequiredDatalist.appendChild(option);
            });
        }


        // --- Export to Excel ---
        function exportToExcel() {
            const ws_data = [];

            // Main Headers: Section / Deliverable, then Area Names, then Actions
            const headerRow = ['Section / Deliverable'];
            projectData.areas.forEach(area => {
                headerRow.push(area.name + ' - Status');
                headerRow.push(area.name + ' - Due Date');
            });
            headerRow.push('AM Required'); // Add these directly to the excel output headers
            headerRow.push('Responsible Department');
            headerRow.push('Notes');
            ws_data.push(headerRow);

            // Populate data rows
            projectData.sections.forEach(section => {
                // Section row
                const sectionRowData = [section.name];
                for (let i = 0; i < projectData.areas.length * 2 + 3; i++) { // +3 for AM, Dept, Notes
                    sectionRowData.push(''); // Empty cells for areas in section row
                }
                ws_data.push(sectionRowData);

                function addChildrenToExcel(children, indent = 0) {
                    children.forEach(item => {
                        const rowData = [];
                        const indentStr = ' '.repeat(indent * 2); // 2 spaces per indent level

                        if (item.type === 'subsection') {
                            rowData.push(`${indentStr}‚ñ∂ ${item.name}`);
                            for (let i = 0; i < projectData.areas.length * 2 + 3; i++) {
                                rowData.push(''); // Empty cells for areas in subsection row
                            }
                            ws_data.push(rowData);
                            addChildrenToExcel(item.children, indent + 1);
                        } else if (item.type === 'deliverable') {
                            rowData.push(`${indentStr}- ${item.name}`);

                            projectData.areas.forEach(area => {
                                const areaInfo = item.areaData[area.id] || { status: "", dueDate: "" };
                                rowData.push(areaInfo.status);
                                rowData.push(areaInfo.dueDate);
                            });
                            // Add deliverable-level properties
                            rowData.push(item.amRequired);
                            rowData.push(item.responsibleDepartment);
                            rowData.push(item.notes);

                            ws_data.push(rowData);
                        }
                    });
                }
                addChildrenToExcel(item.children, 1);
            });

            // Create worksheet and workbook
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Project Deliverables");

            // Save the file
            XLSX.writeFile(wb, `${projectData.title}_Deliverables.xlsx`);
            addChangeLogEntry("Project data exported to Excel.");
        }


        // --- Import from Excel ---
        function importFromExcel(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON array, skipping first row (headers)
                // header: 1 means first row is header, but we'll manage headers manually
                // Since we need to map custom columns like "AM Required", "Responsible Department", "Notes"
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                if (jsonData.length < 2) {
                    alert("Excel file is empty or missing data rows.");
                    return;
                }

                // Assume first row is headers for mapping
                const importedHeaders = jsonData[0];
                const importedRows = jsonData.slice(1);

                // Clear current project data to import fresh
                projectData = {
                    title: projectData.title, // Keep existing title or set to a default
                    sections: [],
                    areas: [],
                    nextSectionId: 1,
                    nextDeliverableId: 1,
                    nextAreaId: 1
                };

                // Map headers to identify Area columns and special deliverable properties
                const areaColumnMap = {}; // { 'Area Name - Status': areaId, 'Area Name - Due Date': areaId }
                let amRequiredColIndex = -1;
                let responsibleDepartmentColIndex = -1;
                let notesColIndex = -1;

                importedHeaders.forEach((header, index) => {
                    if (header.endsWith(' - Status')) {
                        const areaName = header.replace(' - Status', '');
                        const newAreaId = `area_col_${projectData.nextAreaId++}`;
                        projectData.areas.push({ id: newAreaId, name: areaName });
                        areaColumnMap[header] = newAreaId;
                        areaColumnMap[header.replace('Status', 'Due Date')] = newAreaId; // Map due date too
                    } else if (header === 'AM Required') {
                        amRequiredColIndex = index;
                    } else if (header === 'Responsible Department') {
                        responsibleDepartmentColIndex = index;
                    } else if (header === 'Notes') {
                        notesColIndex = index;
                    }
                });

                let currentSection = null;
                let currentSubsection = null;

                importedRows.forEach(row => {
                    const firstCell = row[0] ? String(row[0]).trim() : '';

                    if (!firstCell) return; // Skip empty rows

                    // Check if it's a Section
                    if (!firstCell.startsWith(' ') && !firstCell.startsWith('‚ñ∂') && !firstCell.startsWith('-')) {
                        // This is likely a new section
                        currentSection = {
                            id: `s${projectData.nextSectionId++}`,
                            name: firstCell,
                            type: "section",
                            color: SECTION_COLORS[colorIndex++ % SECTION_COLORS.length],
                            isCollapsed: false,
                            children: []
                        };
                        projectData.sections.push(currentSection);
                        currentSubsection = null; // Reset subsection when new section starts
                    } else if (firstCell.startsWith('‚ñ∂')) {
                        // This is a subsection
                        if (currentSection) {
                            const subsectionName = firstCell.replace('‚ñ∂', '').trim();
                            currentSubsection = {
                                id: `sub${projectData.nextSectionId++}`,
                                name: subsectionName,
                                type: "subsection",
                                children: []
                            };
                            currentSection.children.push(currentSubsection);
                        }
                    } else if (firstCell.startsWith('-')) {
                        // This is a deliverable
                        if (currentSection) {
                            const deliverableName = firstCell.replace('-', '').trim();
                            const newDeliverable = {
                                id: `d${projectData.nextDeliverableId++}`,
                                name: deliverableName,
                                type: "deliverable",
                                amRequired: amRequiredColIndex !== -1 && row[amRequiredColIndex] !== undefined ? String(row[amRequiredColIndex]) : '',
                                responsibleDepartment: responsibleDepartmentColIndex !== -1 && row[responsibleDepartmentColIndex] !== undefined ? String(row[responsibleDepartmentColIndex]) : '',
                                notes: notesColIndex !== -1 && row[notesColIndex] !== undefined ? String(row[notesColIndex]) : '',
                                areaData: {}
                            };

                            // Populate areaData for the deliverable
                            projectData.areas.forEach(area => {
                                const statusHeader = `${area.name} - Status`;
                                const dueDateHeader = `${area.name} - Due Date`;
                                const statusIndex = importedHeaders.indexOf(statusHeader);
                                const dueDateIndex = importedHeaders.indexOf(dueDateHeader);

                                newDeliverable.areaData[area.id] = {
                                    status: statusIndex !== -1 && row[statusIndex] !== undefined ? String(row[statusIndex]) : 'NotStarted',
                                    dueDate: dueDateIndex !== -1 && row[dueDateIndex] !== undefined ? String(row[dueDateIndex]) : ''
                                };
                            });

                            if (currentSubsection) {
                                currentSubsection.children.push(newDeliverable);
                            } else {
                                currentSection.children.push(newDeliverable);
                            }
                        }
                    }
                });

                saveProjectData();
                renderTable();
                addChangeLogEntry("Project data imported from Excel.");
                alert("Data imported successfully!");
            };
            reader.readAsArrayBuffer(file);
        }


        // --- Reset Project ---
        function resetProject() {
            if (confirm("Are you sure you want to reset the entire project? This action cannot be undone.")) {
                projectData = {
                    title: "My Awesome Project",
                    sections: [],
                    areas: [],
                    nextSectionId: 1,
                    nextDeliverableId: 1,
                    nextAreaId: 1
                };
                addChangeLogEntry("Project has been reset.", "danger");
                saveProjectData();
                renderTable();
                alert("Project has been reset to an empty state.");
            }
        }

        // --- Change Log ---
        function addChangeLogEntry(message, type = "info") {
            const timestamp = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
            const entry = `[${timestamp}] ${message}`;
            changeLogEntries.unshift(entry); // Add to the beginning

            // Keep only the latest entries
            if (changeLogEntries.length > MAX_CHANGE_LOG_ENTRIES) {
                changeLogEntries.pop(); // Remove the oldest entry
            }

            renderChangeLog();
        }

        function renderChangeLog() {
            changeLogList.innerHTML = '';
            changeLogEntries.forEach(entry => {
                const li = document.createElement('li');
                li.textContent = entry;
                changeLogList.appendChild(li);
            });
            // Ensure the log is visible when an entry is added
            document.querySelector('.change-log-container').style.display = 'block';
        }

        // --- Connectivity Indicator ---
        const connectivityIndicator = document.getElementById('connectivityIndicator');

        function updateConnectivityIndicator(isOnline) {
            if (isOnline) {
                connectivityIndicator.style.backgroundColor = '#4CAF50'; // Green for online
                connectivityIndicator.setAttribute('data-tooltip', 'Online (Connected)');
            } else {
                connectivityIndicator.style.backgroundColor = '#F44336'; // Red for offline
                connectivityIndicator.setAttribute('data-tooltip', 'Offline (No Internet)');
            }
        }

        // Function to check connectivity by trying to reach Firebase or a known reliable host
        function fetchConnectivityStatus() {
            // Ping Firebase's database URL
            const testUrl = firebaseConfig.databaseURL + '/.info/servertime';
            fetch(testUrl, { method: 'GET', mode: 'no-cors' }) // no-cors prevents CORS errors on success, just tells us if fetch could initiate
                .then(() => {
                    updateConnectivityIndicator(true);
                })
                .catch(() => {
                    updateConnectivityIndicator(false);
                });
        }

    </script>
</body>
</html>
